<script>
  function gerarNumeroOS() {
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = String(hoje.getFullYear()).slice(2);
    const prefixo = `${dia}${mes}${ano}`;
    let contador = parseInt(localStorage.getItem(`contador_${prefixo}`)) || 1;
    const numeroOS = `${prefixo}-${String(contador).padStart(3, '0')}`;
    localStorage.setItem(`contador_${prefixo}`, contador + 1);
    return numeroOS;
  }

  function inicializarOS() {
    const numeroOS = gerarNumeroOS();
    document.getElementById('osNumber').innerText = numeroOS;
    document.getElementById('dataEntrada').innerText = formatarData(new Date());

    document.getElementById('acessorioSim').addEventListener('change', () => {
      document.getElementById('qualAcessorioLinha').classList.toggle('hidden', !acessorioSim.checked);
    });
    document.getElementById('acessorioNao').addEventListener('change', () => {
      if (acessorioNao.checked) document.getElementById('qualAcessorioLinha').classList.add('hidden');
    });

    document.getElementById('defeitoSim').addEventListener('change', () => {
      document.getElementById('qualDefeitoLinha').classList.toggle('hidden', !defeitoSim.checked);
    });
    document.getElementById('defeitoNao').addEventListener('change', () => {
      if (defeitoNao.checked) document.getElementById('qualDefeitoLinha').classList.add('hidden');
    });

    carregarHistorico();
  }

  function salvarOS() {
    const os = {
      numero: document.getElementById('osNumber').innerText,
      nome: document.getElementById('nomeCliente').value,
      telefone: document.getElementById('telefoneCliente').value,
      whatsapp: document.getElementById('whatsappCheck').checked,
      tecnico: document.getElementById('tecnicoResponsavel').value,
      marcaModelo: document.getElementById('marcaModelo').value,
      acessorio: acessorioSim.checked ? 'SIM' : acessorioNao.checked ? 'NÃO' : '',
      qualAcessorio: document.getElementById('qualAcessorio').value,
      liga: ligaSim.checked ? 'SIM' : ligaNao.checked ? 'NÃO' : '',
      defeitoFisico: defeitoSim.checked ? 'SIM' : defeitoNao.checked ? 'NÃO' : '',
      qualDefeito: document.getElementById('qualDefeito').value,
      defeitoCliente: document.getElementById('defeitoCliente').value,
      dataEntrada: document.getElementById('dataEntrada').innerText,
      dataSaida: document.getElementById('dataSaida').value,
      assinaturaCliente: document.getElementById('assinaturaCliente').value,
      assinaturaTecnico: document.getElementById('assinaturaTecnico').value,
      senha: document.getElementById('senha').value,
      dataRegistro: new Date().toISOString()
    };

    let historico = JSON.parse(localStorage.getItem('historicoOS') || '[]');
    historico.push(os);
    localStorage.setItem('historicoOS', JSON.stringify(historico));
    alert("OS salva com sucesso!");
  }

  function abrirHistorico() {
    document.getElementById('historicoPopup').style.display = 'block';
  }

  function fecharHistorico() {
    document.getElementById('historicoPopup').style.display = 'none';
  }

  function carregarHistorico() {
    const lista = document.getElementById('listaHistorico');
    lista.innerHTML = '';

    const historico = JSON.parse(localStorage.getItem('historicoOS') || '[]');
    const agora = new Date();
    const noventaDias = 90 * 24 * 60 * 60 * 1000;

    historico.reverse().forEach(os => {
      const dataOS = new Date(os.dataRegistro);
      if (agora - dataOS <= noventaDias) {
        const item = document.createElement('div');
        item.textContent = `${os.numero} - ${os.nome}`;
        item.onclick = () => preencherOS(os);
        lista.appendChild(item);
      }
    });
  }

  function preencherOS(os) {
    document.getElementById('osNumber').innerText = os.numero;
    document.getElementById('nomeCliente').value = os.nome;
    document.getElementById('telefoneCliente').value = os.telefone;
    document.getElementById('whatsappCheck').checked = os.whatsapp;
    document.getElementById('tecnicoResponsavel').value = os.tecnico;
    document.getElementById('marcaModelo').value = os.marcaModelo;
    document.getElementById('acessorioSim').checked = os.acessorio === 'SIM';
    document.getElementById('acessorioNao').checked = os.acessorio === 'NÃO';
    document.getElementById('qualAcessorio').value = os.qualAcessorio;
    document.getElementById('ligaSim').checked = os.liga === 'SIM';
    document.getElementById('ligaNao').checked = os.liga === 'NÃO';
    document.getElementById('defeitoSim').checked = os.defeitoFisico === 'SIM';
    document.getElementById('defeitoNao').checked = os.defeitoFisico === 'NÃO';
    document.getElementById('qualDefeito').value = os.qualDefeito;
    document.getElementById('defeitoCliente').value = os.defeitoCliente;
    document.getElementById('dataEntrada').innerText = os.dataEntrada;
    document.getElementById('dataSaida').value = os.dataSaida;
    document.getElementById('assinaturaCliente').value = os.assinaturaCliente;
    document.getElementById('assinaturaTecnico').value = os.assinaturaTecnico;
    document.getElementById('senha').value = os.senha;

    // Mostrar campos escondidos se necessário
    if (os.acessorio === 'SIM') document.getElementById('qualAcessorioLinha').classList.remove('hidden');
    if (os.defeitoFisico === 'SIM') document.getElementById('qualDefeitoLinha').classList.remove('hidden');
  }
</script>
