<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OS - CNT Assistência</title>
  <style>
    /* TODO: SEUS ESTILOS CSS ORIGINAIS DO download.htm */
    :root {
      /* Variáveis de cores */
      --background-dark: #1a1a1a;
      --text-light: #f0f0f0;
      --input-bg: #333333;
      --input-border: #555555;
      --input-focus-border: #007bff;
      --accent-color: orange;
      --accent-hover: #cc8400;
      --orange-progress: orange;
      --separator-color: #444444;
      --readonly-text: #aaaaaa;
    }

    body {
      margin: 0;
      background-color: var(--background-dark);
      color: var(--text-light);
      font-family: 'Roboto', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden; /* Evita rolagem desnecessária */
      font-size: 16px;
      line-height: 1.6;
    }

    .barra-progresso {
      width: 15px;
      background-color: var(--input-bg);
      display: flex;
      flex-direction: column-reverse; /* Enche de baixo para cima */
      justify-content: flex-start;
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      z-index: 100;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
    }

    #barra {
      width: 100%;
      background-color: var(--orange-progress);
      transition: height 0.3s ease-out;
      height: 0%; /* Começa vazio */
    }

    .menu-lateral {
      width: 60px;
      background-color: var(--background-dark);
      padding-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      border-right: 1px solid var(--separator-color);
      z-index: 200; /* Acima da barra de progresso */
    }

    .menu-item {
      background: none;
      border: none;
      color: var(--text-light);
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.5em; /* Ícones maiores */
      transition: background-color 0.3s ease, color 0.3s ease;
      width: 40px; /* Largura fixa para os botões */
      height: 40px; /* Altura fixa para os botões */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .menu-item:hover {
      background-color: var(--input-bg);
      color: var(--accent-color);
    }

    .menu-item i {
      pointer-events: none; /* Garante que o clique seja no botão, não no ícone */
    }

    .main-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto; /* Permite rolagem no conteúdo principal */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background-color: var(--input-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      box-sizing: border-box;
      margin-bottom: 20px; /* Espaço para o botão principal */
    }

    h1, h2 {
      color: var(--accent-color);
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
    }

    .form-section {
      margin-bottom: 30px;
      border: 1px solid var(--separator-color);
      padding: 20px;
      border-radius: 8px;
      background-color: #2a2a2a;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-light);
    }

    input[type="text"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    textarea {
      width: calc(100% - 18px); /* Ajustado para padding e borda */
      padding: 10px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      background-color: #444444;
      color: var(--text-light);
      box-sizing: border-box;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    input[readonly] {
      background-color: #555555;
      color: var(--readonly-text);
      cursor: not-allowed;
    }

    .radio-group label {
      display: inline-block;
      margin-right: 20px;
      font-weight: normal;
      cursor: pointer;
    }

    .radio-group input[type="radio"] {
      margin-right: 5px;
      transform: scale(1.2); /* Aumenta o tamanho do radio button */
    }

    .condicional-campo {
      display: none; /* Oculto por padrão */
      margin-top: 15px;
      padding: 10px;
      background-color: #3a3a3a;
      border-radius: 5px;
      border: 1px dashed var(--separator-color);
    }

    #mainActionButton {
      background-color: var(--accent-color);
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
      transition: background-color 0.3s ease;
    }

    #mainActionButton:hover {
      background-color: var(--accent-hover);
    }

    /* Estilos para a área de impressão */
    .print-area {
        display: none; /* Oculto por padrão, visível apenas na impressão */
        background-color: #fff;
        color: #000;
        padding: 20mm; /* Margens para impressão A4 */
        box-sizing: border-box;
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
        line-height: 1.4;
        width: 210mm; /* Largura de uma folha A4 */
        min-height: 297mm; /* Altura de uma folha A4 */
        margin: 0 auto; /* Centraliza na tela quando visível fora do print */
        box-shadow: 0 0 10px rgba(0,0,0,0.1); /* Sombra para visualização */
        page-break-after: always; /* Garante que cada via fique em uma nova página */
    }

    .print-area:last-child {
        page-break-after: avoid; /* A última via não deve quebrar a página após si */
    }

    .titulo {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #ccc;
        padding-bottom: 10px;
    }

    .titulo img {
        max-width: 180px;
        height: auto;
        margin-bottom: 10px;
    }

    .titulo h2 {
        font-size: 2em;
        margin: 0;
        color: #000;
        text-transform: uppercase;
    }
    .titulo .contato {
        font-size: 1.1em;
        color: #555;
        margin-top: 5px;
    }

    .linha {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
        gap: 20px; /* Espaçamento entre colunas */
    }

    .col {
        flex: 1;
        min-width: 200px; /* Garante que colunas não fiquem muito estreitas */
        display: flex;
        flex-direction: column;
    }

    .col label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
        font-size: 0.9em;
    }

    .print-only-field {
        border: 1px solid #000;
        padding: 5px;
        min-height: 25px; /* Altura mínima para campos vazios */
        display: block;
        box-sizing: border-box;
        word-wrap: break-word; /* Quebra palavras longas */
        font-size: 1em;
    }

    textarea.print-only-field {
        min-height: 80px; /* Altura maior para defeito relatado */
    }

    .termos-condicoes {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 25px;
        background-color: #f9f9f9;
        font-size: 0.9em;
        page-break-before: auto; /* Evita que os termos sejam cortados no meio da página */
        page-break-inside: avoid; /* Não quebra os termos dentro da área */
    }

    .termos-condicoes h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #000;
        border-bottom: 1px dashed #999;
        padding-bottom: 8px;
    }

    .termos-condicoes ol {
        padding-left: 25px;
        margin-bottom: 15px;
    }

    .termos-condicoes li {
        margin-bottom: 8px;
    }
    .termos-condicoes p {
      margin: 0;
      font-size: 0.95em;
    }
    .termos-condicoes strong {
      color: #000;
    }

    .garantia-dias-span {
        display: inline-block;
        width: 60px;
        border-bottom: 1px solid #000;
        text-align: center;
        line-height: 1.2;
        vertical-align: middle;
    }

    .assinaturas-row {
        display: flex;
        justify-content: space-around;
        margin-top: 40px;
        text-align: center;
        gap: 30px;
        flex-wrap: wrap;
    }

    .assinatura-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 250px;
    }

    .linha-assinatura {
        border-bottom: 1px solid #000;
        width: 100%;
        margin-bottom: 5px;
        min-height: 1.5em; /* Garante que a linha apareça mesmo sem conteúdo */
    }

    .linha-assinatura-label {
        font-size: 1em;
        color: #333;
        font-weight: bold;
    }

    /* Ocultar elementos não essenciais na impressão */
    @media print {
        body {
            overflow: visible !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .barra-progresso, .menu-lateral, .main-content, #mainActionButton, #messagePopup {
            display: none !important; /* Oculta toda a interface do formulário */
        }
        .print-area {
            display: block !important;
            width: 100% !important;
            padding: 10mm !important; /* Margens de impressão */
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
        }
        .print-only-field {
            border: 1px solid #000 !important;
            padding: 2px 4px !important;
            min-height: 1.2em !important;
        }
        .titulo img {
            filter: grayscale(100%) !important; /* Print em preto e branco */
        }
        .termos-condicoes {
            border: 1px solid #000 !important;
            background-color: #fff !important;
            box-shadow: none !important;
        }
        * {
            -webkit-print-color-adjust: exact !important; /* Garante cores no print */
            print-color-adjust: exact !important;
        }
    }

    /* Popup de mensagem */
    .message-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #333333;
      color: var(--text-light);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
      text-align: center;
      font-size: 1.1em;
      border: 1px solid var(--accent-color);
    }

    .message-popup button {
      background-color: var(--accent-color);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 1em;
      transition: background-color 0.3s ease;
      width: auto;
    }

    .message-popup button:hover {
      background-color: var(--accent-hover);
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="barra-progresso">
    <div id="barra"></div>
  </div>

  <div class="menu-lateral">
    <button class="menu-item" onclick="goHome()">
      <i class="fas fa-home"></i>
    </button>
    <button class="menu-item" onclick="goHistorico()">
      <i class="fas fa-history"></i>
    </button>
  </div>

  <div class="main-content">
    <div class="container">
      <h1>Ordem de Serviço</h1>
      <form id="osForm" onsubmit="event.preventDefault(); printOS();">
        <div class="form-section">
          <h2>Dados da Ordem de Serviço</h2>
          <div class="form-group">
            <label for="osNumber">Número da OS:</label>
            <input type="text" id="osNumber" required readonly>
          </div>
          <div class="form-group">
            <label for="dataEntrada">Data de Entrada:</label>
            <input type="date" id="dataEntrada" required readonly>
          </div>
          <div class="form-group">
            <label for="dataSaida">Data de Saída (Opcional):</label>
            <input type="date" id="dataSaida">
          </div>
          <div class="form-group">
            <label for="tecnico">Técnico Responsável:</label>
            <input type="text" id="tecnico" value="Seu Nome" required>
          </div>
        </div>

        <div class="form-section">
          <h2>Dados do Cliente</h2>
          <div class="form-group">
            <label for="nomeCliente">Nome do Cliente:</label>
            <input type="text" id="nomeCliente" required>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" placeholder="(DD) XXXXX-XXXX" maxlength="15" oninput="formatarTelefone(this)" required>
          </div>
        </div>

        <div class="form-section">
          <h2>Dados do Equipamento</h2>
          <div class="form-group">
            <label for="equipamento">Equipamento:</label>
            <input type="text" id="equipamento" required>
          </div>
          <div class="form-group">
            <label>Acessório:</label>
            <div class="radio-group">
              <label><input type="radio" name="acessorio" id="acessorioSim" value="sim" onchange="configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio')"> Sim</label>
              <label><input type="radio" name="acessorio" id="acessorioNao" value="nao" onchange="configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio')" checked> Não</label>
            </div>
            <div id="campoAcessorio" class="condicional-campo">
              <label for="qualAcessorio">Qual acessório?</label>
              <input type="text" id="qualAcessorio">
            </div>
          </div>

          <div class="form-group">
            <label>Liga o equipamento?</label>
            <div class="radio-group">
              <label><input type="radio" name="liga" id="ligaSim" value="sim"> Sim</label>
              <label><input type="radio" name="liga" id="ligaNao" value="nao" checked> Não</label>
            </div>
          </div>

          <div class="form-group">
            <label>Defeito Físico?</label>
            <div class="radio-group">
              <label><input type="radio" name="defeito" id="defeitoSim" value="sim" onchange="configurarRadios('defeito', 'campoDefeito', 'qualDefeito')"> Sim</label>
              <label><input type="radio" name="defeito" id="defeitoNao" value="nao" onchange="configurarRadios('defeito', 'campoDefeito', 'qualDefeito')" checked> Não</label>
            </div>
            <div id="campoDefeito" class="condicional-campo">
              <label for="qualDefeito">Qual defeito físico?</label>
              <input type="text" id="qualDefeito">
            </div>
          </div>

          <div class="form-group">
            <label for="defeitoRelatado">Defeito Relatado pelo Cliente:</label>
            <textarea id="defeitoRelatado" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="garantiaDias">Dias de Garantia:</label>
            <input type="number" id="garantiaDias" value="90" min="0" required>
          </div>
        </div>
        <button type="submit" id="mainActionButton">Imprimir OS</button>
      </form>
    </div>
  </div>

  <div id="printContainer"></div>

  <div id="messagePopup" class="message-popup">
    <p id="popupMessage"></p>
    <button onclick="hideMessagePopup()">Ok</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      loadLastOSNumber();
      setTodayDate();
      configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio');
      configurarRadios('defeito', 'campoDefeito', 'qualDefeito');
      atualizarProgresso();
    });

    function showMessagePopup(message) {
      document.getElementById('popupMessage').innerText = message;
      document.getElementById('messagePopup').style.display = 'block';
    }

    function hideMessagePopup() {
      document.getElementById('messagePopup').style.display = 'none';
    }

    function loadLastOSNumber() {
      let lastOSNumber = localStorage.getItem('last_os_number');
      if (lastOSNumber) {
        lastOSNumber = parseInt(lastOSNumber) + 1;
      } else {
        lastOSNumber = 1;
      }
      document.getElementById('osNumber').value = lastOSNumber.toString().padStart(4, '0');
    }

    function setTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('dataEntrada').value = `${year}-${month}-${day}`;
    }

    function formatarTelefone(input) {
      let value = input.value.replace(/\D/g, "");
      let formattedValue = '';

      if (value.length > 0) {
        formattedValue = '(' + value.substring(0, 2);
      }
      if (value.length > 2) {
        formattedValue += ') ' + value.substring(2, 7);
      }
      if (value.length > 7) {
        formattedValue += '-' + value.substring(7, 11);
      }
      input.value = formattedValue;
    }

    function configurarRadios(radioName, campoId, inputId) {
      const radioSim = document.getElementById(`${radioName}Sim`);
      const campoCondicional = document.getElementById(campoId);
      const inputCondicional = document.getElementById(inputId);

      if (radioSim && campoCondicional && inputCondicional) {
        if (radioSim.checked) {
          campoCondicional.style.display = 'block';
          inputCondicional.setAttribute('required', 'true');
        } else {
          campoCondicional.style.display = 'none';
          inputCondicional.removeAttribute('required');
          inputCondicional.value = '';
        }
      }
      atualizarProgresso();
    }

    function generateUniqueId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveOSData() {
        const osNumber = document.getElementById('osNumber').value;
        const dataEntrada = document.getElementById('dataEntrada').value;
        const nomeCliente = document.getElementById('nomeCliente').value;
        const equipamento = document.getElementById('equipamento').value;
        const defeitoRelatado = document.getElementById('defeitoRelatado').value;

        // Validação dos campos obrigatórios
        if (!osNumber || !dataEntrada || !nomeCliente || !equipamento || !defeitoRelatado) {
            showMessagePopup("Por favor, preencha todos os campos obrigatórios antes de salvar.");
            return false;
        }

        const osData = {
            id: generateUniqueId(),
            timestamp: Date.now(),
            osNumber: osNumber,
            dataEntrada: formatDateToDisplay(document.getElementById('dataEntrada').value),
            dataSaida: formatDateToDisplay(document.getElementById('dataSaida').value) || '___/___/___',
            nomeCliente: nomeCliente,
            telefone: document.getElementById('telefone').value,
            tecnico: document.getElementById('tecnico').value,
            equipamento: equipamento,
            acessorioSim: document.getElementById('acessorioSim').checked,
            qualAcessorio: document.getElementById('qualAcessorio').value,
            ligaSim: document.getElementById('ligaSim').checked,
            defeitoFisicoSim: document.getElementById('defeitoSim').checked,
            qualDefeito: document.getElementById('qualDefeito').value,
            defeitoRelatado: defeitoRelatado,
            garantiaDias: document.getElementById('garantiaDias').value || '90'
        };

        const osHistory = JSON.parse(localStorage.getItem('os_history') || '[]');
        osHistory.push(osData);
        localStorage.setItem('os_history', JSON.stringify(osHistory));
        localStorage.setItem('last_os_number', parseInt(osNumber));

        console.log('OS salva no histórico:', osData);
        return true;
    }

    function formatDateToDisplay(dateString) {
      if (!dateString) return '';
      const [year, month, day] = dateString.split('-');
      return `${day}/${month}/${year}`;
    }

    function createPrintableContent(isClientCopy) {
      const osNumber = document.getElementById('osNumber').value;
      const dataEntrada = formatDateToDisplay(document.getElementById('dataEntrada').value);
      const dataSaida = formatDateToDisplay(document.getElementById('dataSaida').value) || '___/___/___';
      const nomeCliente = document.getElementById('nomeCliente').value;
      const telefone = document.getElementById('telefone').value;
      const tecnico = document.getElementById('tecnico').value;
      const equipamento = document.getElementById('equipamento').value;
      const acessorioSim = document.getElementById('acessorioSim').checked;
      const qualAcessorio = document.getElementById('qualAcessorio').value;
      const ligaSim = document.getElementById('ligaSim').checked;
      const defeitoFisicoSim = document.getElementById('defeitoSim').checked;
      const qualDefeito = document.getElementById('qualDefeito').value;
      const defeitoRelatado = document.getElementById('defeitoRelatado').value;
      const garantiaDias = document.getElementById('garantiaDias').value || '90';

      const termosCondicoesHTML = `
        <div class="termos-condicoes">
          <h3>Termos e Condições</h3>
          <ol>
            <li>
              <strong>Recebimento do Equipamento</strong>
              <p>O equipamento entregue será avaliado, registrando estado físico, avarias e acessórios recebidos. Não nos responsabilizamos por itens não declarados.</p>
            </li>
            <li>
              <strong>Diagnóstico e Orçamento</strong>
              <p>O diagnóstico será realizado em até 3 dias úteis. O serviço só será iniciado após aprovação do orçamento pelo cliente.</p>
            </li>
            <li>
              <strong>Garantia</strong>
              <p>Garantia de <span class="garantia-dias-span">${garantiaDias}</span> dias para o serviço realizado, limitada ao reparo efetuado. Não cobre mau uso, quedas, líquidos ou intervenções de terceiros.</p>
            </li>
            <li>
              <strong>Equipamentos Não Retirados</strong>
              <p>Após 30 dias da conclusão, será cobrada taxa de armazenamento de R$ 1,00/dia. Após 90 dias, o equipamento será considerado abandonado, conforme o Código Civil Artigo 1.275, inciso III.</p>
            </li>
            <li>
              <strong>Perda de Dados</strong>
              <p>Não nos responsabilizamos por perda de dados. Recomenda-se backup antes da entrega. Backup solicitado será cobrado à parte.</p>
            </li>
            <li>
              <strong>Peças Substituídas</strong>
              <p>Garantia de <span class="garantia-dias-span">${garantiaDias}</span> dias para peças substituídas contra defeitos de fabricação. Peças originais mediante solicitação e disponibilidade.</p>
            </li>
          </ol>
        </div>
      `;

      return `
        <div class="print-area">
          <div class="titulo">
            <img src="logo.png" alt="Logo CNT Assistência Técnica">
            <div class="contato">Contato: 84 99809-6865</div>
          </div>
          <h2>${isClientCopy ? 'VIA DO CLIENTE' : 'ORDEM DE SERVIÇO'}</h2>
          <div class="linha">
            <div class="col"><label>OS Nº</label><span class="print-only-field">${osNumber}</span></div>
            <div class="col"><label>DATA ENTRADA</label><span class="print-only-field">${dataEntrada}</span></div>
            <div class="col"><label>DATA SAÍDA</label><span class="print-only-field">${dataSaida}</span></div>
          </div>
          <div class="linha">
            <div class="col"><label>CLIENTE</label><span class="print-only-field">${nomeCliente}</span></div>
            <div class="col"><label>TELEFONE</label><span class="print-only-field">${telefone}</span></div>
            <div class="col"><label>TÉCNICO</label><span class="print-only-field">${tecnico}</span></div>
          </div>
          <div class="linha">
            <div class="col"><label>EQUIPAMENTO</label><span class="print-only-field">${equipamento}</span></div>
          </div>
          <div class="linha">
            <div class="col"><label>ACESSÓRIO</label><span class="print-only-field">${acessorioSim ? 'SIM' : 'NÃO'}</span></div>
            ${acessorioSim && qualAcessorio ? `<div class="col"><label>QUAL</label><span class="print-only-field">${qualAcessorio}</span></div>` : ''}
          </div>
          <div class="linha">
            <div class="col"><label>LIGA</label><span class="print-only-field">${ligaSim ? 'SIM' : 'NÃO'}</span></div>
          </div>
          <div class="linha">
            <div class="col"><label>DEFEITO FÍSICO</label><span class="print-only-field">${defeitoFisicoSim ? 'SIM' : 'NÃO'}</span></div>
            ${defeitoFisicoSim && qualDefeito ? `<div class="col"><label>QUAL</label><span class="print-only-field">${qualDefeito}</span></div>` : ''}
          </div>
          <div class="linha">
            <div class="col"><label>DEFEITO RELATADO</label><span class="print-only-field" style="min-height: 3.5em;">${defeitoRelatado}</span></div>
          </div>
          ${termosCondicoesHTML}
          <div class="linha assinaturas-row">
            <div class="col">
              <div class="assinatura-container">
                <span class="linha-assinatura"></span>
                <span class="linha-assinatura-label">ASS. CLIENTE / ENTREGA</span>
              </div>
            </div>
            <div class="col">
              <div class="assinatura-container">
                <span class="linha-assinatura"></span>
                <span class="linha-assinatura-label">ASS. CNT ASSISTÊNCIA / RETIRADA</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function printOS() {
      // Valida o formulário antes de prosseguir
      if (!document.getElementById('osForm').checkValidity()) {
        showMessagePopup("Por favor, preencha todos os campos obrigatórios antes de imprimir.");
        return;
      }

      // Tenta salvar os dados da OS no localStorage
      const savedSuccessfully = saveOSData();
      if (!savedSuccessfully) {
          return; // Se houver problema no salvamento (ex: campos obrigatórios vazios), interrompe
      }

      const printContainer = document.getElementById('printContainer');
      printContainer.innerHTML = ''; // Limpa o conteúdo existente

      // Gera a via da loja
      const lojaCopy = createPrintableContent(false);
      printContainer.innerHTML += lojaCopy; // Use += para adicionar, não substituir

      // Gera a via do cliente
      const clientCopy = createPrintableContent(true);
      printContainer.innerHTML += clientCopy; // Use += para adicionar, não substituir

      // Esconde o formulário da tela e mostra a área de impressão
      document.querySelector('.main-content').style.display = 'none';
      document.querySelector('.barra-progresso').style.display = 'none';
      document.querySelector('.menu-lateral').style.display = 'none';
      document.getElementById('mainActionButton').style.display = 'none';
      printContainer.style.display = 'block';


      setTimeout(() => {
        window.print();
        // Após a impressão, reverte para o estado original
        document.querySelector('.main-content').style.display = 'flex';
        document.querySelector('.barra-progresso').style.display = 'flex';
        document.querySelector('.menu-lateral').style.display = 'flex';
        document.getElementById('mainActionButton').style.display = 'block';

        printContainer.style.display = 'none';
        printContainer.innerHTML = ''; // Limpa a área de impressão novamente

        // Garante que os campos condicionais da tela voltem ao estado correto
        configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio');
        configurarRadios('defeito', 'campoDefeito', 'qualDefeito');

        // Recarrega a página para uma nova OS limpa e incrementa o número da OS
        setTimeout(() => {
            location.reload();
        }, 100);
      }, 300);
    }

    function atualizarProgresso() {
      const form = document.getElementById('osForm');
      const inputs = form.querySelectorAll('input[required], textarea[required], input[type="radio"]');
      let filledCount = 0;
      let totalFieldsConsidered = 0;

      const radioGroups = {}; // Para controlar grupos de rádio já contados

      inputs.forEach(input => {
        if (input.type === 'radio') {
            const radioGroupName = input.name;
            if (!radioGroups[radioGroupName]) { // Se o grupo de rádio ainda não foi processado
                totalFieldsConsidered++;
                const radiosInGroup = document.querySelectorAll(`input[type="radio"][name="${radioGroupName}"]`);
                if (Array.from(radiosInGroup).some(radio => radio.checked)) {
                    filledCount++;
                }
                radioGroups[radioGroupName] = true; // Marca o grupo como processado
            }
        } else if (input.hasAttribute('required')) {
            // Campos obrigatórios de texto, número, data, textarea
            // E campos condicionais que se tornaram obrigatórios e estão visíveis
            const isConditionalAndHidden = input.closest('.condicional-campo') && input.closest('.condicional-campo').style.display === 'none';

            if (!isConditionalAndHidden) {
                totalFieldsConsidered++;
                if (input.value.trim() !== '') {
                    filledCount++;
                }
            }
        }
      });

      const progress = totalFieldsConsidered > 0 ? Math.round((filledCount / totalFieldsConsidered) * 100) : 0;
      const barraElement = document.getElementById("barra");
      if (barraElement) {
        barraElement.style.height = progress + "%";
      }
    }

    // Adicionar listeners para atualizar progresso em tempo real
    document.querySelectorAll('#osForm input, #osForm textarea').forEach(input => {
        input.addEventListener('input', atualizarProgresso);
    });
    // Adicionar listeners especificamente para os radios, pois 'input' pode não pegar todas as mudanças
    document.querySelectorAll('#osForm input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', atualizarProgresso);
    });

    // Funções para navegação
    function goHome() {
        // Redireciona para a página inicial (se houver)
        // Certifique-se de que 'index.html' é o nome correto do seu arquivo inicial
        window.location.href = 'index.html';
    }

    function goHistorico() {
        // Redireciona para a página de histórico (se houver)
        // Certifique-se de que 'historico.html' é o nome correto do seu arquivo de histórico
        window.location.href = 'historico.html';
    }
  </script>
</body>
</html>
