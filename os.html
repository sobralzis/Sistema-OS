<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ordem de Serviço</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      background: #f9f9f9;
      color: #222;
    }
    h1 {
      color: #004080;
    }
    label {
      display: block;
      margin-top: 0.5em;
    }
    input[type=text], input[type=date], textarea {
      width: 100%;
      padding: 0.3em;
      margin-top: 0.2em;
      box-sizing: border-box;
    }
    .btn {
      margin-top: 1em;
      background-color: #004080;
      color: white;
      border: none;
      padding: 0.6em 1.2em;
      font-size: 1em;
      cursor: pointer;
      border-radius: 0.3em;
      display: inline-flex;
      align-items: center;
      gap: 0.4em;
    }
    .btn svg {
      fill: white;
      width: 1em;
      height: 1em;
    }
    .btn:hover {
      background-color: #0060c0;
    }
    #historicoPopup {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #004080;
      padding: 1em;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 999;
    }
    #historicoPopup h2 {
      margin-top: 0;
      color: #004080;
    }
    #listaHistorico div {
      padding: 0.3em;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    #listaHistorico div:hover {
      background-color: #eef6ff;
    }
    .form-section {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 0.3em;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body onload="preencherDataEIncrementarOS()">

  <h1>Ordem de Serviço</h1>

  <div class="form-section">
    <p><strong>DATA:</strong> <span id="dataEntrada"></span></p>
    <p><strong>Nº da OS:</strong> <span id="osNumber"></span></p>

    <label for="nomeCliente">Nome do Cliente</label>
    <input type="text" id="nomeCliente" />

    <label for="telefone">Telefone</label>
    <input type="text" id="telefone" />

    <label>
      <input type="checkbox" id="whatsapp" /> WhatsApp
    </label>

    <label for="tecnico">Técnico Responsável</label>
    <input type="text" id="tecnico" />

    <label for="marcaModelo">Marca e Modelo do Equipamento</label>
    <input type="text" id="marcaModelo" />

    <label>Acessórios:</label>
    <label><input type="checkbox" id="acessorioSim" /> Sim</label>
    <label><input type="checkbox" id="acessorioNao" /> Não</label>
    <div id="qualAcessorioLinha" style="display:none;">
      <label for="qualAcessorio">Qual acessório?</label>
      <textarea id="qualAcessorio" rows="2"></textarea>
    </div>

    <label>O equipamento liga?</label>
    <label><input type="checkbox" id="ligaSim" /> Sim</label>
    <label><input type="checkbox" id="ligaNao" /> Não</label>

    <label>Apresenta defeito?</label>
    <label><input type="checkbox" id="defeitoSim" /> Sim</label>
    <label><input type="checkbox" id="defeitoNao" /> Não</label>
    <div id="qualDefeitoLinha" style="display:none;">
      <label for="qualDefeito">Qual defeito?</label>
      <textarea id="qualDefeito" rows="2"></textarea>
    </div>

    <label for="defeitoCliente">Defeito informado pelo cliente</label>
    <textarea id="defeitoCliente" rows="2"></textarea>

    <label for="dataSaida">Data de retirada (prevista)</label>
    <input type="date" id="dataSaida" />

    <label for="assinaturaCliente">Assinatura do cliente</label>
    <input type="text" id="assinaturaCliente" />

    <label for="assinaturaTecnico">Assinatura do técnico</label>
    <input type="text" id="assinaturaTecnico" />

    <label for="senha">Senha (se houver)</label>
    <input type="text" id="senha" />
  </div>

  <button class="btn" onclick="window.print()">
    <svg viewBox="0 0 24 24"><path d="M6 9H18V15H6zM6 5H18V7H6zM6 17H18V19H6z"/></svg>
    IMPRIMIR ORDEM
  </button>

  <button class="btn" style="margin-left:1em;" onclick="abrirHistorico()">
    <svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
    HISTÓRICO
  </button>

  <div id="historicoPopup">
    <h2>Histórico de OS</h2>
    <div id="listaHistorico"></div>
    <button class="btn" style="margin-top:1em; background:#888;" onclick="fecharHistorico()">Fechar</button>
  </div>

  <script>
    function preencherDataEIncrementarOS() {
      const hoje = new Date();
      const dataFormatada = hoje.toLocaleDateString('pt-BR');
      document.getElementById('dataEntrada').textContent = dataFormatada;

      let osAtual = parseInt(localStorage.getItem('osAtual') || '0', 10);
      osAtual++;
      localStorage.setItem('osAtual', osAtual);
      document.getElementById('osNumber').textContent = osAtual;

      limparFormulario();
    }

    function limparFormulario() {
      document.getElementById('nomeCliente').value = '';
      document.getElementById('telefone').value = '';
      document.getElementById('whatsapp').checked = false;
      document.getElementById('tecnico').value = '';
      document.getElementById('marcaModelo').value = '';
      document.getElementById('acessorioSim').checked = false;
      document.getElementById('acessorioNao').checked = false;
      document.getElementById('ligaSim').checked = false;
      document.getElementById('ligaNao').checked = false;
      document.getElementById('defeitoSim').checked = false;
      document.getElementById('defeitoNao').checked = false;
      document.getElementById('qualAcessorio').value = '';
      document.getElementById('qualDefeito').value = '';
      document.getElementById('qualAcessorioLinha').style.display = 'none';
      document.getElementById('qualDefeitoLinha').style.display = 'none';
      document.getElementById('defeitoCliente').value = '';
      document.getElementById('dataSaida').value = '';
      document.getElementById('assinaturaCliente').value = '';
      document.getElementById('assinaturaTecnico').value = '';
      document.getElementById('senha').value = '';
    }

    document.getElementById('acessorioSim').addEventListener('change', () => {
      const acessorioSim = document.getElementById('acessorioSim').checked;
      document.getElementById('qualAcessorioLinha').style.display = acessorioSim ? 'block' : 'none';
      if (!acessorioSim) document.getElementById('qualAcessorio').value = '';
      if (acessorioSim) document.getElementById('acessorioNao').checked = false;
    });
    document.getElementById('acessorioNao').addEventListener('change', () => {
      if (document.getElementById('acessorioNao').checked) {
        document.getElementById('acessorioSim').checked = false;
        document.getElementById('qualAcessorioLinha').style.display = 'none';
        document.getElementById('qualAcessorio').value = '';
      }
    });

    document.getElementById('defeitoSim').addEventListener('change', () => {
      const defeitoSim = document.getElementById('defeitoSim').checked;
      document.getElementById('qualDefeitoLinha').style.display = defeitoSim ? 'block' : 'none';
      if (!defeitoSim) document.getElementById('qualDefeito').value = '';
      if (defeitoSim) document.getElementById('defeitoNao').checked = false;
    });
    document.getElementById('defeitoNao').addEventListener('change', () => {
      if (document.getElementById('defeitoNao').checked) {
        document.getElementById('defeitoSim').checked = false;
        document.getElementById('qualDefeitoLinha').style.display = 'none';
        document.getElementById('qualDefeito').value = '';
      }
    });

    document.getElementById('ligaSim').addEventListener('change', () => {
      if (document.getElementById('ligaSim').checked) {
        document.getElementById('ligaNao').checked = false;
      }
    });
    document.getElementById('ligaNao').addEventListener('change', () => {
      if (document.getElementById('ligaNao').checked) {
        document.getElementById('ligaSim').checked = false;
      }
    });

    window.onbeforeprint = function() {
      salvarOSNoHistorico();
    };

    function salvarOSNoHistorico() {
      const osNumber = document.getElementById('osNumber').textContent;
      const dataEntrada = document.getElementById('dataEntrada').textContent;

      const osDados = {
        osNumber,
        dataEntrada,
        nomeCliente: document.getElementById('nomeCliente').value,
        telefone: document.getElementById('telefone').value,
        whatsapp: document.getElementById('whatsapp').checked,
        tecnico: document.getElementById('tecnico').value,
        marcaModelo: document.getElementById('marcaModelo').value,
        acessorioSim: document.getElementById('acessorioSim').checked,
        acessorioNao: document.getElementById('acessorioNao').checked,
        ligaSim: document.getElementById('ligaSim').checked,
        ligaNao: document.getElementById('ligaNao').checked,
        defeitoSim: document.getElementById('defeitoSim').checked,
        defeitoNao: document.getElementById('defeitoNao').checked,
        qualAcessorio: document.getElementById('qualAcessorio').value,
        qualDefeito: document.getElementById('qualDefeito').value,
        defeitoCliente: document.getElementById('defeitoCliente').value,
        dataSaida: document.getElementById('dataSaida').value,
        assinaturaCliente: document.getElementById('assinaturaCliente').value,
        assinaturaTecnico: document.getElementById('assinaturaTecnico').value,
        senha: document.getElementById('senha').value,
        timestamp: new Date().getTime()
      };

      let historico = JSON.parse(localStorage.getItem('historicoOS') || '[]');

      // Remove OS antiga do mesmo número para evitar duplicidade
      historico = historico.filter(item => item.osNumber !== osNumber);

      historico.push(osDados);

      const limite = new Date();
      limite.setDate(limite.getDate() - 90);
      historico = historico.filter(item => item.timestamp >= limite.getTime());

      localStorage.setItem('historicoOS', JSON.stringify(historico));
    }

    function abrirHistorico() {
      const popup = document.getElementById('historicoPopup');
      const lista = document.getElementById('listaHistorico');
      lista.innerHTML = '';

      let historico = JSON.parse(localStorage.getItem('historicoOS') || '[]');

      historico.sort((a, b) => b.osNumber - a.osNumber);

      if (historico.length === 0) {
        lista.innerHTML = '<p>Nenhuma OS encontrada no histórico.</p>';
      } else {
        historico.forEach(item => {
          const div = document.createElement('div');
          // Exibe no formato DATA - Nº da OS - Nome do Cliente
          div.textContent = `${item.dataEntrada} - Nº ${item.osNumber} - ${item.nomeCliente}`;
          div.title = "Clique para carregar esta OS";
          div.style.userSelect = "none";
          div.addEventListener('click', () => {
            carregarOS(item);
            fecharHistorico();
          });
          lista.appendChild(div);
        });
      }
      popup.style.display = 'block';
    }

    function fecharHistorico() {
      document.getElementById('historicoPopup').style.display = 'none';
    }

    function carregarOS(osDados) {
      document.getElementById('osNumber').textContent = osDados.osNumber;
      document.getElementById('dataEntrada').textContent = osDados.dataEntrada;

      document.getElementById('nomeCliente').value = osDados.nomeCliente || '';
      document.getElementById('telefone').value = osDados.telefone || '';
      document.getElementById('whatsapp').checked = !!osDados.whatsapp;
      document.getElementById('tecnico').value = osDados.tecnico || '';
      document.getElementById('marcaModelo').value = osDados.marcaModelo || '';
      document.getElementById('acessorioSim').checked = !!osDados.acessorioSim;
      document.getElementById('acessorioNao').checked = !!osDados.acessorioNao;
      document.getElementById('ligaSim').checked = !!osDados.ligaSim;
      document.getElementById('ligaNao').checked = !!osDados.ligaNao;
      document.getElementById('defeitoSim').checked = !!osDados.defeitoSim;
      document.getElementById('defeitoNao').checked = !!osDados.defeitoNao;

      document.getElementById('qualAcessorioLinha').style.display = osDados.acessorioSim ? 'block' : 'none';
      document.getElementById('qualAcessorio').value = osDados.qualAcessorio || '';

      document.getElementById('qualDefeitoLinha').style.display = osDados.defeitoSim ? 'block' : 'none';
      document.getElementById('qualDefeito').value = osDados.qualDefeito || '';

      document.getElementById('defeitoCliente').value = osDados.defeitoCliente || '';
      document.getElementById('dataSaida').value = osDados.dataSaida || '';
      document.getElementById('assinaturaCliente').value = osDados.assinaturaCliente || '';
      document.getElementById('assinaturaTecnico').value = osDados.assinaturaTecnico || '';
      document.getElementById('senha').value = osDados.senha || '';
    }
  </script>

</body>
</html>
