<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OS - CNT Assistência</title>
  <style>
    /* ===== VARIÁVEIS ===== */
    :root {
      --bg-dark: #1D1D1D;
      --bg-secondary: #2A2A2A;
      --border-color: #444;
      --text-light: #fff;
      --accent-color: #2A2A2A;
      --error-color: #ff4444;
      --progress-color: #ffffff;
      --input-bg: var(--bg-secondary);
      --input-border: var(--border-color);
      --input-focus-border: #007bff;
      --accent-hover: #3A3A3A;
      --orange-progress: var(--progress-color);
      --separator-color: #444444;
      --readonly-text: #aaaaaa;
    }

    /* ===== ESTILOS GERAIS ===== */
    body {
      margin: 0;
      background-color: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 16px;
      line-height: 1.6;
    }

    /* ===== BARRA DE PROGRESSO ===== */
    .barra-progresso {
      width: 15px;
      background-color: var(--bg-secondary);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      border-right: 1px solid var(--separator-color);
      z-index: 1001;
      display: flex;
      flex-direction: column-reverse;
      justify-content: flex-start;
    }

    .progresso {
      width: 100%;
      background-color: var(--progress-color);
      transition: height 0.5s ease;
      height: 0%;
      position: absolute;
      bottom: 0;
    }

    /* ===== CONTEÚDO PRINCIPAL ===== */
    .conteudo {
      margin-left: 35px;
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      padding-bottom: 120px;
      box-sizing: border-box;
    }

    /* ===== FORM STEPS ===== */
    .form-step {
      display: none;
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(42, 42, 42, 0.3);
      border-radius: 8px;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.5s ease-in-out, max-height 0.5s ease-in-out, margin-bottom 0.5s ease-in-out;
    }

    .form-step.visible-step {
      display: block;
      animation: fadeIn 0.3s ease;
      opacity: 1;
      max-height: 1000px;
      margin-bottom: 25px;
    }

    .form-step.completed {
      opacity: 0.8;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== ESTRUTURA DO FORMULÁRIO ===== */
    .input-area {
      max-width: 800px;
      margin: 0 auto;
    }

    .linha {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
      padding: 0;
    }

    .col {
      flex: 1;
      min-width: 200px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text-light);
    }

    input, select, textarea, input[type="number"] {
      width: 100%;
      padding: 10px;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-light);
      box-sizing: border-box;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .invalid, .invalid-field {
      border-color: var(--error-color) !important;
      box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2) !important;
    }

    input:focus, select:focus, textarea:focus, input[type="number"]:focus {
        border-color: var(--input-focus-border);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
        outline: none;
    }

    select {
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23f0f0f0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
        padding-right: 40px;
    }

    .readonly-field {
        color: var(--readonly-text);
        font-size: 14px;
        padding: 8px 0;
        display: block;
        margin-bottom: 0px;
        border-bottom: 1px dashed var(--separator-color);
        padding-bottom: 5px;
    }

    /* ===== GRUPOS DE RÁDIO ===== */
    .radio-container {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 12px;
      background-color: var(--bg-secondary);
      flex: 1;
      min-width: 0;
    }

    .radio-group, .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .radio-group span, .checkbox-group span {
      font-weight: 500;
      white-space: nowrap;
      font-size: 14px;
    }

    .radio-group label, .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: normal;
    }

    .radio-group input[type="radio"], .checkbox-group input[type="radio"] {
        width: auto;
        margin: 0;
        padding: 0;
        transform: scale(1.2);
        accent-color: var(--progress-color);
    }

    /* ===== BOTÕES DE AÇÃO ===== */
    .fixed-action-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 25px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1em;
      z-index: 1000;
      transition: background-color 0.3s;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .fixed-action-button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    .fixed-action-button:disabled {
      background-color: var(--input-border);
      color: var(--readonly-text);
      cursor: not-allowed;
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }

    .inicio-action-button, .historico-button {
      position: fixed;
      background-color: var(--accent-color);
      color: var(--text-light);
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
      font-weight: bold;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .inicio-action-button {
        top: 20px;
        left: 20px;
    }

    .historico-button {
        top: 20px;
        right: 20px;
    }

    .inicio-action-button:hover, .historico-button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    .inicio-action-button:disabled, .historico-button:disabled {
      background-color: var(--input-border);
      color: var(--readonly-text);
      cursor: not-allowed;
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }

    /* ===== TÍTULO E CONTATO ===== */
    .titulo {
      text-align: center;
      margin-bottom: 15px;
      margin-top: 5px;
    }

    .titulo img {
        max-height:60px;
        height:auto;
        margin-bottom: 5px;
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
    }

    .contato {
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
      color: var(--readonly-text);
    }

    .conteudo h2 {
        text-align: center;
        margin:10px 0;
        font-size:18px;
        color: var(--text-light);
        border-bottom: 1px dashed var(--separator-color);
        padding-bottom: 10px;
    }

    .hidden {
      display: none !important;
    }

    /* TERMOS E CONDIÇÕES */
    .termos-condicoes {
      margin-top: 10px;
      padding: 10px;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .termos-condicoes h3 {
      text-align:center;
      margin:10px 0;
      font-size:14px;
      color: var(--text-light);
      border-bottom: 1px dashed var(--separator-color);
      padding-bottom: 10px;
    }

    .termos-condicoes ol {
      list-style-type: decimal;
      padding-left:20px;
      margin:8px 0;
      font-size:12px;
    }

    .termos-condicoes li {
        margin-bottom: 10px;
    }
    .termos-condicoes p {
        margin: 5px 0;
        color: var(--text-light);
        font-size: 0.95em;
    }
    .termos-condicoes strong {
        color: var(--progress-color);
    }

    /* Assinaturas */
    .assinatura-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-top: 15px;
    }
    .linha-assinatura {
        border-top: 1px solid #000;
        padding-top: 25px;
        margin-top: 30px;
        display: block;
        width: 100%;
        min-height: 1em;
        box-sizing: border-box;
    }
    .linha-assinatura-label {
        text-align: center;
        font-weight: normal;
        font-size: 0.9em;
        margin-top: 5px;
        padding-bottom: 5px;
    }
    .assinaturas-row {
        display: flex !important;
        gap: 20px !important;
        margin-top: 15px !important;
        flex-wrap: wrap !important;
    }
    .assinaturas-row .col {
        flex: 1;
        min-width: 200px;
    }

    /* Garantia Input */
    .garantia-dias-span {
        display: inline-block;
        width: 60px;
        border-bottom: 1px solid var(--separator-color);
        text-align: center;
        line-height: 1;
        vertical-align: middle;
        color: var(--text-light);
    }

    #garantiaDiasInput {
        width: 80px;
        text-align: center;
        margin-left: 5px;
        margin-right: 5px;
        padding: 5px 10px;
        font-size: 1em;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        color: var(--text-light);
        border-radius: 4px;
        -moz-appearance: textfield;
    }

    #garantiaDiasInput::placeholder {
      color: var(--readonly-text);
      opacity: 0.7;
      font-size: 0.9em;
    }

    #garantiaDiasInput::-webkit-outer-spin-button,
    #garantiaDiasInput::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Estilos específicos para impressão */
    .print-only-field {
          display: block !important;
          color: #000 !important;
          font-size: 1em !important;
          border: 1px solid #000 !important;
          padding: 2px 4px !important;
          border-radius: 2px !important;
          box-sizing: border-box !important;
          min-height: 1.2em !important;
          white-space: pre-wrap !important;
    }
    .col .print-only-field {
          width: 100% !important;
    }

    /* ===== RESPONSIVIDADE ===== */
    @media (max-width: 768px) {
      .radio-container {
        min-width: 100%;
      }
      
      .linha {
        flex-direction: column;
        gap: 10px;
      }
      
      .col {
        width: 100%;
      }
    }

    @media (max-width: 600px) {
        .conteudo {
            margin-left: 0;
            padding-left: 20px;
            padding-right: 20px;
        }
        .barra-progresso {
            display: none;
        }
    }

    @media (max-width: 480px) {
        .col {
            min-width: 100%;
        }
        .linha {
            flex-direction: column;
            gap: 15px;
        }
    }
  </style>
</head>
<body onload="inicializarOS()">
  <div class="barra-progresso">
    <div id="barra" class="progresso"></div>
  </div>

  <button id="homeButton" class="inicio-action-button" onclick="goHome()">INICIO</button>
  <button id="historicoButton" class="historico-button" onclick="goHistorico()">HISTÓRICO</button>

  <div class="conteudo">
    <div class="titulo">
      <img src="img/logo.png" alt="Logo" onerror="this.style.display='none'">
      <div class="contato">Contato: 84 99809-6865</div>
    </div>
    
    <h2 style="text-align:center;">ORDEM DE SERVIÇO</h2>

    <div class="linha initial-active" style="margin-bottom:15px;">
      <div class="col">
        <label>OS Nº</label>
        <span id="osNumber" class="readonly-field"></span>
      </div>
      <div class="col">
        <label>DATA DE ENTRADA</label>
        <span id="dataEntrada" class="readonly-field"></span>
      </div>
      <div class="col">
        <label>DATA DE SAÍDA</label>
        <span id="dataSaida" class="readonly-field"></span>
      </div>
    </div>

    <div class="form-step" data-step="1">
      <div class="input-area">
        <div class="linha">
          <div class="col">
            <label for="nomeCliente">NOME DO CLIENTE</label>
            <input type="text" id="nomeCliente" required minlength="3" data-form-field="true">
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" data-step="2">
      <div class="input-area">
        <div class="linha">
          <div class="col">
            <label for="telefone">TELEFONE</label>
            <input type="tel" id="telefone" placeholder="(00) 0 0000-0000" maxlength="15" required data-form-field="true">
          </div>
          <div class="col">
            <label for="tecnico">TÉCNICO</label>
            <select id="tecnico" required data-form-field="true">
              <option value="">Selecione</option>
              <option>Bruno Santos</option>
              <option>João Paulo</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" data-step="3">
      <div class="input-area">
        <div class="linha">
          <div class="col">
            <label for="equipamento">EQUIPAMENTO</label>
            <input type="text" id="equipamento" required data-form-field="true">
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" data-step="4">
      <div class="input-area">
        <div class="linha">
          <div class="radio-container" id="ligaGroup"> <div class="radio-group">
              <span>LIGA:</span>
              <label><input type="radio" name="liga" value="sim" required data-form-field="true"> Sim</label>
              <label><input type="radio" name="liga" value="nao" required data-form-field="true"> Não</label>
            </div>
          </div>
          
          <div class="radio-container" id="acessorioGroup"> <div class="radio-group">
              <span>ACESSÓRIO:</span>
              <label><input type="radio" name="acessorio" value="nao" checked data-form-field="true"> Não</label>
              <label><input type="radio" name="acessorio" value="sim" data-form-field="true"> Sim</label>
            </div>
          </div>
          
          <div class="radio-container" id="defeitoGroup"> <div class="radio-group">
              <span>DEFEITO FÍSICO:</span>
              <label><input type="radio" name="defeito" value="nao" checked data-form-field="true"> Não</label>
              <label><input type="radio" name="defeito" value="sim" data-form-field="true"> Sim</label>
            </div>
          </div>
        </div>
        
        <div class="linha hidden" id="campoAcessorio"> <div class="col">
            <label for="qualAcessorio">QUAL ACESSÓRIO</label>
            <input type="text" id="qualAcessorio" data-form-field="true">
          </div>
        </div>
        
        <div class="linha hidden" id="campoDefeito"> <div class="col">
            <label for="qualDefeito">QUAL DEFEITO</label>
            <input type="text" id="qualDefeito" data-form-field="true">
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" data-step="5">
      <div class="input-area">
        <div class="linha">
          <div class="col">
            <label for="observacoes">OBSERVAÇÕES</label>
            <textarea id="observacoes" rows="3" required data-form-field="true"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="form-step" data-step="6">
      <div class="input-area">
        <div class="linha">
          <div class="col">
            <label for="garantiaDiasInput">DIAS DE GARANTIA (Serviço)</label>
            <input type="number" id="garantiaDiasInput" min="0" placeholder="Deixe em branco para preencher manual" data-form-field="true">
          </div>
        </div>
        
        <div class="termos-condicoes" id="termosFormulario"> <h3>Termos e Condições</h3>
          <ol>
            <li>
              <strong>Recebimento do Equipamento</strong>
              <p>o O equipamento entregue será avaliado, registrando estado físico, avarias e acessórios recebidos. Não nos responsabilizamos por itens não declarados.</p>
            </li>
            <li>
              <strong>Diagnóstico e Orçamento</strong>
              <p>o O diagnóstico será realizado em até 3 dias úteis. O serviço só será iniciado após aprovação do orçamento pelo cliente.</p>
            </li>
            <li>
              <strong>Garantia</strong>
              <p>o Garantia de <span class="garantia-dias-span" id="garantiaServico">______</span> dias para o serviço realizado, limitada ao reparo efetuado. Não cobre mau uso, quedas, líquidos ou intervenções de terceiros.</p>
            </li>
            <li>
              <strong>Equipamentos Não Retirados</strong>
              <p>o Após 30 dias da conclusão, será cobrada taxa de armazenamento de R$ 1,00/dia. Após 90 dias, o equipamento será considerado abandonado, conforme o Código Civil Artigo 1.275, inciso III.</p>
            </li>
            <li>
              <strong>Perda de Dados</strong>
              <p>o Não nos responsabilizamos por perda de dados. Recomenda-se backup antes da entrega. Backup solicitado será cobrado à parte.</p>
            </li>
            <li>
              <strong>Peças Substituídas</strong>
              <p>o Garantia de <span class="garantia-dias-span" id="garantiaPecas">______</span> dias para peças substituídas contra defeitos de fabricação. Peças originais mediante solicitação e disponibilidade.</p>
            </li>
          </ol>
        </div>
      </div>
    </div>

    <div id="printContainer" style="display: none;"></div>

    <button id="mainActionButton" class="fixed-action-button" onclick="handleActionButtonClick()">Próximo →</button>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 6;
    let formInputs = [];

    function collectOSData() {
        return {
            osNumber: document.getElementById('osNumber').textContent,
            dataEntrada: document.getElementById('dataEntrada').textContent,
            dataSaida: document.getElementById('dataSaida').textContent,
            nomeCliente: document.getElementById('nomeCliente').value,
            telefone: document.getElementById('telefone').value,
            tecnico: document.getElementById('tecnico').value,
            equipamento: document.getElementById('equipamento').value,
            acessorioSim: document.querySelector('input[name="acessorio"][value="sim"]:checked') ? true : false,
            qualAcessorio: document.getElementById('qualAcessorio').value,
            ligaSim: document.querySelector('input[name="liga"][value="sim"]:checked') ? true : false,
            defeitoFisicoSim: document.querySelector('input[name="defeito"][value="sim"]:checked') ? true : false,
            qualDefeito: document.getElementById('qualDefeito').value,
            garantiaDias: document.getElementById('garantiaDiasInput').value || null,
            observacoes: document.getElementById('observacoes').value,
            timestamp: new Date().getTime()
        };
    }

    function saveOSData(osData) {
        let history = JSON.parse(localStorage.getItem('os_history') || '[]');
        const existingIndex = history.findIndex(item => item.osNumber === osData.osNumber);
        if (existingIndex > -1) {
            history[existingIndex] = osData;
        } else {
            history.push(osData);
        }
        localStorage.setItem('os_history', JSON.stringify(history));
    }

    function generateOSNumber() {
        const today = new Date();
        const datePart = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
        let counter = parseInt(localStorage.getItem(`osCount_${datePart}`) || '0');
        if (counter >= 99) counter = 0;
        counter++;
        localStorage.setItem(`osCount_${datePart}`, counter.toString());
        return `${today.getFullYear()} ${datePart.slice(4, 6)}${datePart.slice(6, 8)} ${counter.toString().padStart(2, '0')}`;
    }

    function configurarRadios(nomeGrupo, idCampoContainer, idInputAssociado) {
      const campoContainer = document.getElementById(idCampoContainer);
      const inputAssociado = document.getElementById(idInputAssociado);

      document.querySelectorAll(`input[name="${nomeGrupo}"]`).forEach(radio => {
        radio.addEventListener('change', () => {
          if (campoContainer && inputAssociado) {
            if (radio.value === 'sim') {
              campoContainer.classList.remove('hidden');
            } else {
              campoContainer.classList.add('hidden');
              inputAssociado.value = '';
            }
          }
          validarPassoAtual();
        });
      });
    }

    function formatarTelefone(event) {
        let input = event.target;
        let value = input.value.replace(/\D/g, '');

        if (value.length > 11) {
            value = value.substring(0, 11);
        }
        
        if (value.length > 0) {
            if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            }
            if (value.length > 9) {
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
        }
        input.value = value;
        validarPassoAtual();
    }

    function inicializarOS() {
        document.getElementById('osNumber').textContent = generateOSNumber();
        document.getElementById('dataEntrada').textContent = new Date().toLocaleDateString('pt-BR');
        document.getElementById('dataSaida').textContent = '';

        configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio');
        configurarRadios('defeito', 'campoDefeito', 'qualDefeito');
        
        document.getElementById('nomeCliente').addEventListener('input', validarPassoAtual);
        document.getElementById('telefone').addEventListener('input', formatarTelefone);
        document.getElementById('tecnico').addEventListener('change', validarPassoAtual);
        document.getElementById('equipamento').addEventListener('input', validarPassoAtual);
        document.getElementById('observacoes').addEventListener('input', validarPassoAtual);

        document.querySelectorAll('input[name="liga"]').forEach(radio => {
            radio.addEventListener('change', validarPassoAtual);
        });

        document.getElementById('qualAcessorio').addEventListener('input', validarPassoAtual);
        document.getElementById('qualDefeito').addEventListener('input', validarPassoAtual);

        const garantiaInput = document.getElementById('garantiaDiasInput');
        const garantiaServicoSpan = document.getElementById('garantiaServico');
        const garantiaPecasSpan = document.getElementById('garantiaPecas');
        garantiaInput.addEventListener('input', () => {
            garantiaServicoSpan.textContent = garantiaInput.value || "______";
            garantiaPecasSpan.textContent = garantiaInput.value || "______";
        });
        
        document.querySelectorAll("input:not([type='radio']):not([type='checkbox']), select, textarea, input[type='number']").forEach(input => {
            input.setAttribute('data-form-field', 'true');
            input.addEventListener('keydown', handleEnterKey);
            input.addEventListener('input', () => {
                input.classList.remove('invalid-field');
            });
            input.addEventListener('change', () => {
                input.classList.remove('invalid-field');
            });
        });
        
        document.querySelectorAll('.radio-group, .checkbox-group').forEach(group => {
            group.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(radioOrCheckbox => {
                radioOrCheckbox.setAttribute('data-form-field', 'true');
                radioOrCheckbox.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        if (validarPassoAtual()) {
                            focusNextInputInStep(event.target);
                        }
                    }
                });
                radioOrCheckbox.addEventListener('change', () => {
                    const radioName = radioOrCheckbox.name;
                    const radiosInGroup = document.querySelectorAll(`input[name="${radioName}"]`);
                    if (Array.from(radiosInGroup).some(radio => radio.checked)) {
                        radiosInGroup.forEach(radio => radio.classList.remove('invalid-field'));
                    }
                });
            });
        });
        showStep(currentStep);
        atualizarProgresso();
    }

    function handleEnterKey(event) {
        if (event.target.tagName === 'TEXTAREA') {
            return;
        }

        if (event.key === 'Enter') {
            event.preventDefault();
            if (validarPassoAtual()) {
                focusNextInputInStep(event.target);
            } else {
                alert("Verifique os Campos em Vermelho");
            }
        }
    }

    function focusNextInputInStep(currentInput) {
        const allVisibleInputs = Array.from(document.querySelectorAll("[data-form-field='true']"))
                                    .filter(input => {
                                        return input.offsetParent !== null && !input.closest('.hidden') && !input.readOnly;
                                    });
        const currentInputIndex = allVisibleInputs.indexOf(currentInput);

        if (currentInputIndex > -1 && currentInputIndex < allVisibleInputs.length - 1) {
            allVisibleInputs[currentInputIndex + 1].focus();
        } else {
            if (validarPassoAtual()) {
                nextStep();
            }
        }
    }

    function validarPassoAtual() {
      const currentFormStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
      let isValid = true;
      let hasInvalidFields = false;

      if (!currentFormStepElement) return true;

      currentFormStepElement.querySelectorAll("input, select, textarea").forEach(input => {
          input.classList.remove('invalid-field');
      });

      const inputsToValidate = Array.from(currentFormStepElement.querySelectorAll("input:not([type='radio']):not([type='checkbox']), select, textarea, input[type='number']"))
                                    .filter(input => input.offsetParent !== null && !input.closest('.hidden'));
      
      inputsToValidate.forEach(input => {
          let fieldIsValid = true;

          if (input.id === 'nomeCliente') {
              if (input.value.trim().length < 3) {
                  fieldIsValid = false;
              }
          } else if (input.id === 'telefone') {
              const cleanedValue = input.value.replace(/\D/g, '');
              if (cleanedValue.length !== 11) {
                  fieldIsValid = false;
              }
          } else if (input.id === 'tecnico') {
              if (input.value === '') {
                  fieldIsValid = false;
              }
          } else if (input.id === 'qualAcessorio') {
              const acessorioSimChecked = document.querySelector('input[name="acessorio"][value="sim"]:checked');
              if (acessorioSimChecked && input.value.trim().length < 5) {
                  fieldIsValid = false;
              }
          } else if (input.id === 'qualDefeito') {
              const defeitoSimChecked = document.querySelector('input[name="defeito"][value="sim"]:checked');
              if (defeitoSimChecked && input.value.trim().length < 5) {
                  fieldIsValid = false;
              }
          } else if (input.required && input.value.trim() === '') {
              fieldIsValid = false;
          }

          if (!fieldIsValid) {
              input.classList.add('invalid-field');
              isValid = false;
              hasInvalidFields = true;
          }
      });

      currentFormStepElement.querySelectorAll('.radio-group, .checkbox-group').forEach(group => {
          if (group.offsetParent !== null && !group.closest('.hidden')) {
              const radioName = group.querySelector('input[type="radio"]')?.name;
              if (radioName) {
                  const radiosInGroup = document.querySelectorAll(`input[name="${radioName}"]`);
                  const isAnyRadioChecked = Array.from(radiosInGroup).some(radio => radio.checked);
                  const isRequiredGroup = Array.from(radiosInGroup).some(radio => radio.required);

                  if (isRequiredGroup && !isAnyRadioChecked) {
                      radiosInGroup.forEach(radio => radio.classList.add('invalid-field'));
                      isValid = false;
                      hasInvalidFields = true;
                  } else {
                      radiosInGroup.forEach(radio => radio.classList.remove('invalid-field'));
                  }
              }
          }
      });

      const mainActionButton = document.getElementById('mainActionButton');
      if (mainActionButton) {
          let ligaSelected = true;
          if (currentStep === 4) {
             const ligaRadios = document.querySelectorAll('input[name="liga"]');
             ligaSelected = Array.from(ligaRadios).some(radio => radio.checked);
          }
          mainActionButton.disabled = hasInvalidFields || !ligaSelected;
      }

      return isValid;
    }

    function showStep(step) {
      document.querySelectorAll('.form-step').forEach(s => {
        const stepNum = parseInt(s.dataset.step);
        s.classList.toggle('visible-step', stepNum <= step);
      });
      const mainActionButton = document.getElementById('mainActionButton');
      if (mainActionButton) {
          mainActionButton.textContent = (step === totalSteps) ? 'Salvar e Imprimir' : 'Próximo →';
      }
      validarPassoAtual();
      atualizarProgresso();
      const currentFormStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
      if (currentFormStepElement) {
          const firstInput = currentFormStepElement.querySelector("input:not([type='radio']):not([type='checkbox']):not(.hidden):not([readonly]), select:not(.hidden):not([readonly]), textarea:not(.hidden):not([readonly]), input[type='number']:not(.hidden):not([readonly])");
          if (firstInput) {
              firstInput.focus();
          } else {
              const firstRadioOrCheckbox = currentFormStepElement.querySelector("input[type='radio']:not(.hidden), input[type='checkbox']:not(.hidden)");
              if (firstRadioOrCheckbox) {
                  firstRadioOrCheckbox.focus();
              }
          }
      }
    }

    function handleActionButtonClick() {
        if (validarPassoAtual()) {
            if (currentStep === totalSteps) {
                salvarImprimir();
            } else {
                nextStep();
            }
        } else {
            alert("Verifique os Campos em Vermelho");
        }
    }

    function nextStep() {
      if (validarPassosAnteriores() && validarPassoAtual()) {
        currentStep = Math.min(currentStep + 1, totalSteps);
        showStep(currentStep);
      } else {
        alert("Verifique os Campos em Vermelho");
      }
    }

    function validarPassosAnteriores() {
        let allPreviousStepsValid = true;
        for (let i = 1; i < currentStep; i++) {
            const stepElement = document.querySelector(`.form-step[data-step="${i}"]`);
            if (stepElement) {
                stepElement.querySelectorAll("input:not([type='radio']):not([type='checkbox']), select, textarea, input[type='number']").forEach(input => {
                    if (input.required && input.value.trim() === '') {
                        allPreviousStepsValid = false;
                        input.classList.add('invalid-field');
                    } else {
                        input.classList.remove('invalid-field');
                    }
                });
                stepElement.querySelectorAll('.radio-group, .checkbox-group').forEach(group => {
                    const radioName = group.querySelector('input[type="radio"]')?.name;
                    if (radioName) {
                        const radiosInGroup = document.querySelectorAll(`input[name="${radioName}"]`);
                        const isAnyRadioChecked = Array.from(radiosInGroup).some(radio => radio.checked);
                        const isRequiredGroup = Array.from(radiosInGroup).some(radio => radio.required);
                        if (isRequiredGroup && !isAnyRadioChecked) {
                            allPreviousStepsValid = false;
                            radiosInGroup.forEach(radio => radio.classList.add('invalid-field'));
                        } else {
                            radiosInGroup.forEach(radio => radio.classList.remove('invalid-field'));
                        }
                    }
                });
            }
        }
        return allPreviousStepsValid;
    }

    function salvarImprimir() {
        const osDataToSave = collectOSData();
        saveOSData(osDataToSave);

        if (!validarPassoAtual()) {
            alert("Verifique os Campos em Vermelho. A OS foi salva, mas revise os dados antes de imprimir.");
            return;
        }

        // Criar um iframe para impressão
        const iframe = document.createElement('iframe');
        iframe.style.position = 'absolute';
        iframe.style.width = '210mm'; // Largura A4
        iframe.style.height = '297mm'; // Altura A4
        iframe.style.left = '-9999px';
        iframe.style.top = '0';
        iframe.style.border = 'none';
        
        document.body.appendChild(iframe);

        // Quando o iframe estiver carregado, adicionar o conteúdo
        iframe.onload = function() {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Adicionar estilos
            const style = iframeDoc.createElement('style');
            style.innerHTML = `
                @page {
                    size: A4;
                    margin: 10mm;
                }
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    color: #000;
                }
                .print-page {
                    width: 210mm;
                    height: 297mm;
                    margin: 0 auto;
                    padding: 10mm;
                    box-sizing: border-box;
                    page-break-after: always;
                }
                .print-page:last-child {
                    page-break-after: auto;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 15px;
                }
                .print-header img {
                    max-height: 60px;
                }
                .print-title {
                    text-align: center;
                    font-size: 18px;
                    margin: 10px 0 20px 0;
                    border-bottom: 1px dashed #000;
                    padding-bottom: 10px;
                }
                .print-row {
                    display: flex;
                    margin-bottom: 8px;
                }
                .print-row-inline {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 8px;
                }
                .print-label {
                    font-weight: bold;
                    width: 120px;
                }
                .print-value {
                    flex: 1;
                    border-bottom: 1px solid #000;
                    min-height: 1.2em;
                    padding-left: 10px;
                }
                .print-value-large {
                    flex: 1;
                    border: 1px solid #000;
                    min-height: 5em;
                    padding: 5px;
                    white-space: pre-wrap;
                }
                .print-terms {
                    margin-top: 20px;
                    border: 1px solid #000;
                    padding: 10px;
                    font-size: 11px;
                }
                .print-signatures {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 30px;
                }
                .print-signature {
                    width: 45%;
                    text-align: center;
                }
                .signature-line {
                    border-top: 1px solid #000;
                    padding-top: 25px;
                    margin-bottom: 5px;
                }
            `;
            iframeDoc.head.appendChild(style);

            // Adicionar conteúdo
            const content = iframeDoc.createElement('div');
            
            // Adicionar ambas as vias (loja e cliente)
            content.innerHTML = generatePrintContent(false) + generatePrintContent(true);
            
            iframeDoc.body.appendChild(content);

            // Esperar um momento para garantir que tudo está carregado
            setTimeout(() => {
                // Chamar a impressão
                iframe.contentWindow.focus();
                iframe.contentWindow.print();

                // Remover o iframe após impressão
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 1000);
            }, 500);
        };

        // Iniciar o processo
        iframe.src = 'about:blank';
    }

    function generatePrintContent(isClientCopy) {
        const garantiaDias = document.getElementById('garantiaDiasInput').value || '______';
        const temAcessorio = document.querySelector('input[name="acessorio"]:checked')?.value === 'sim';
        const temDefeito = document.querySelector('input[name="defeito"]:checked')?.value === 'sim';
        
        return `
        <div class="print-page">
            <div class="print-header">
                <img src="img/logo.png" alt="Logo CNT Assistência Técnica">
                <div>Contato: 84 99809-6865</div>
            </div>
            
            <div class="print-title">${isClientCopy ? 'VIA DO CLIENTE' : 'ORDEM DE SERVIÇO'}</div>
            
            <div class="print-row-inline">
                <div style="width: 30%;">
                    <div class="print-label">OS Nº</div>
                    <div class="print-value">${document.getElementById('osNumber').textContent}</div>
                </div>
                <div style="width: 30%;">
                    <div class="print-label">DATA ENTRADA</div>
                    <div class="print-value">${document.getElementById('dataEntrada').textContent}</div>
                </div>
                <div style="width: 30%;">
                    <div class="print-label">DATA SAÍDA</div>
                    <div class="print-value">${document.getElementById('dataSaida').textContent}</div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-label">CLIENTE</div>
                <div class="print-value">${document.getElementById('nomeCliente').value}</div>
            </div>
            <div class="print-row">
                <div class="print-label">TELEFONE</div>
                <div class="print-value">${document.getElementById('telefone').value}</div>
            </div>
            <div class="print-row">
                <div class="print-label">TÉCNICO</div>
                <div class="print-value">${document.getElementById('tecnico').value}</div>
            </div>
            <div class="print-row">
                <div class="print-label">EQUIPAMENTO</div>
                <div class="print-value">${document.getElementById('equipamento').value}</div>
            </div>
            
            ${temAcessorio ? `
            <div class="print-row">
                <div class="print-label">ACESSÓRIO</div>
                <div class="print-value">Sim</div>
            </div>
            <div class="print-row">
                <div class="print-label">QUAL ACESSÓRIO</div>
                <div class="print-value">${document.getElementById('qualAcessorio').value}</div>
            </div>
            ` : ''}
            
            <div class="print-row">
                <div class="print-label">LIGA</div>
                <div class="print-value">${document.querySelector('input[name="liga"]:checked')?.value === 'sim' ? 'Sim' : 'Não'}</div>
            </div>
            
            ${temDefeito ? `
            <div class="print-row">
                <div class="print-label">DEFEITO FÍSICO</div>
                <div class="print-value">Sim</div>
            </div>
            <div class="print-row">
                <div class="print-label">QUAL DEFEITO</div>
                <div class="print-value">${document.getElementById('qualDefeito').value}</div>
            </div>
            ` : ''}
            
            <div class="print-row">
                <div class="print-label">OBSERVAÇÕES</div>
                <div class="print-value">${document.getElementById('observacoes').value}</div>
            </div>
            
            <div class="print-row">
                <div class="print-label">SERVIÇO REALIZADO</div>
                <div class="print-value-large"></div>
            </div>
            
            <div class="print-terms">
                <h3 style="text-align:center; margin:0 0 10px 0; font-size:14px;">Termos e Condições</h3>
                <ol style="margin:0; padding-left:20px;">
                    <li><strong>Recebimento do Equipamento</strong><br>
                        O equipamento entregue será avaliado, registrando estado físico, avarias e acessórios recebidos. Não nos responsabilizamos por itens não declarados.
                    </li>
                    <li><strong>Diagnóstico e Orçamento</strong><br>
                        O diagnóstico será realizado em até 3 dias úteis. O serviço só será iniciado após aprovação do orçamento pelo cliente.
                    </li>
                    <li><strong>Garantia</strong><br>
                        Garantia de ${garantiaDias} dias para o serviço realizado, limitada ao reparo efetuado. Não cobre mau uso, quedas, líquidos ou intervenções de terceiros.
                    </li>
                    <li><strong>Equipamentos Não Retirados</strong><br>
                        Após 30 dias da conclusão, será cobrada taxa de armazenamento de R$ 1,00/dia. Após 90 dias, o equipamento será considerado abandonado, conforme o Código Civil Artigo 1.275, inciso III.
                    </li>
                    <li><strong>Perda de Dados</strong><br>
                        Não nos responsabilizamos por perda de dados. Recomenda-se backup antes da entrega. Backup solicitado será cobrado à parte.
                    </li>
                    <li><strong>Peças Substituídas</strong><br>
                        Garantia de ${garantiaDias} dias para peças substituídas contra defeitos de fabricação. Peças originais mediante solicitação e disponibilidade.
                    </li>
                </ol>
            </div>
            
            <div class="print-signatures">
                <div class="print-signature">
                    <div class="signature-line"></div>
                    <div>ASS. CLIENTE / ENTREGA</div>
                </div>
                <div class="print-signature">
                    <div class="signature-line"></div>
                    <div>ASS. CLIENTE / RETIRADA</div>
                </div>
            </div>
        </div>
        `;
    }

    function atualizarProgresso() {
      const progress = Math.round((currentStep / totalSteps) * 100);
      const barraElement = document.getElementById("barra");
      if (barraElement) {
          barraElement.style.height = progress + "%";
      } else {
          console.error("Erro: Elemento com ID 'barra' não encontrado para atualizar o progresso.");
      }
    }

    function goHistorico() {
        window.location.href = 'historico.html';
    }

    function goHome() {
        window.location.href = 'index.html';
    }
  </script>
</body>
</html>
