<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OS - CNT Assistência</title>
  <style>
    /* Estilos do seu arquivo original (download.htm) */
    :root {
      /* Variáveis de cores */
      --background-dark: #1a1a1a;
      --text-light: #f0f0f0;
      --input-bg: #333333;
      --input-border: #555555;
      --input-focus-border: #007bff;
      --accent-color: orange;
      --accent-hover: #cc8400;
      --orange-progress: orange;
      --separator-color: #444444;
      --readonly-text: #aaaaaa;
    }

    body {
      margin: 0;
      background-color: var(--background-dark);
      color: var(--text-light);
      font-family: 'Roboto', sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 16px;
      line-height: 1.6;
    }

    .barra-progresso {
      width: 15px;
      background-color: var(--input-bg);
      display: flex;
      flex-direction: column-reverse;
      justify-content: flex-start;
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
    }

    .barra-progresso #barra {
      width: 100%;
      background-color: var(--orange-progress);
      transition: height 0.3s ease-out;
    }

    .container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      background-color: var(--input-bg);
      padding: 15px 20px;
      border-bottom: 1px solid var(--separator-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Permite que os itens quebrem a linha */
      gap: 10px; /* Espaçamento entre os itens */
      position: sticky;
      top: 0;
      z-index: 100;
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      color: var(--accent-color);
    }

    .header-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .header-buttons button {
      background-color: var(--accent-color);
      color: var(--text-light);
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .header-buttons button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-1px);
    }

    .conteudo {
      flex-grow: 1;
      display: flex;
      overflow: hidden;
    }

    .formulario-wrapper {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--scroll-thumb) var(--scroll-track);
    }

    .formulario-wrapper::-webkit-scrollbar {
      width: 10px;
    }
    .formulario-wrapper::-webkit-scrollbar-track {
      background: var(--scroll-track);
    }
    .formulario-wrapper::-webkit-scrollbar-thumb {
      background-color: var(--scroll-thumb);
      border-radius: 5px;
      border: 2px solid var(--scroll-track);
    }

    .form-section {
      background-color: var(--input-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      width: 100%;
      max-width: 800px; /* Limita a largura do formulário */
      box-sizing: border-box;
    }

    .form-section h2 {
      color: var(--accent-color);
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--separator-color);
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-light);
    }

    .form-group input[type="text"],
    .form-group input[type="tel"],
    .form-group input[type="date"],
    .form-group textarea,
    .form-group select {
      width: calc(100% - 20px); /* Ajuste para padding */
      padding: 10px;
      background-color: var(--input-bg); /* Alterado de card-bg para input-bg para consistência */
      border: 1px solid var(--input-border);
      border-radius: 5px;
      color: var(--text-light);
      font-size: 1em;
      box-sizing: border-box; /* Inclui padding na largura total */
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="tel"]:focus,
    .form-group input[type="date"]:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: var(--input-focus-border);
      outline: none;
    }

    .form-group input[readonly],
    .form-group textarea[readonly] {
      background-color: var(--background-dark);
      color: var(--readonly-text);
      cursor: not-allowed;
      border-style: dashed;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap; /* Para responsividade */
    }

    .radio-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
    }

    .radio-group input[type="radio"] {
      margin-right: 8px;
      transform: scale(1.2);
    }

    .condicional-campo {
      margin-top: 15px;
      transition: all 0.3s ease-in-out;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
    }

    .condicional-campo.show {
      opacity: 1;
      max-height: 100px; /* Altura suficiente para o campo */
    }

    .main-actions {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding-bottom: 20px;
      width: 100%;
    }

    .main-actions button {
      background-color: var(--accent-color);
      color: var(--text-light);
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.3s ease, transform 0.2s ease;
      min-width: 150px;
    }

    .main-actions button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
    }

    /* Estilos de impressão - Mantidos para o funcionamento */
    .print-area {
        display: none; /* Oculto por padrão */
        background-color: #fff;
        color: #000;
        padding: 20px;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-size: 12px;
        line-height: 1.4;
        margin: 0 auto;
        page-break-after: always; /* Para que cada via fique em uma página */
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        width: 210mm; /* A4 width */
        min-height: 297mm; /* A4 height */
    }

    .print-area:last-child {
        page-break-after: avoid; /* Não quebra página depois da última via */
    }

    .titulo {
        text-align: center;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .titulo img {
        max-width: 150px;
        height: auto;
        margin-bottom: 10px;
    }

    .titulo h2 {
        font-size: 1.8em;
        margin: 0;
        color: #000;
        text-transform: uppercase;
    }
    .titulo .contato {
        font-size: 1em;
        color: #555;
        margin-top: 5px;
    }

    .linha {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
        gap: 15px; /* Espaçamento entre colunas */
    }

    .col {
        flex: 1;
        min-width: 150px; /* Garante que colunas não fiquem muito estreitas */
        display: flex;
        flex-direction: column;
    }

    .col label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
        font-size: 0.9em;
    }

    .print-only-field {
        border: 1px solid #000;
        padding: 5px;
        min-height: 20px; /* Altura mínima para campos vazios */
        display: block;
        box-sizing: border-box;
        word-wrap: break-word; /* Quebra palavras longas */
        font-size: 0.9em;
    }

    textarea.print-only-field {
        min-height: 60px; /* Altura maior para defeito relatado */
    }

    .termos-condicoes {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 20px;
        background-color: #f9f9f9;
        font-size: 0.85em;
        page-break-before: auto;
        page-break-inside: avoid;
    }

    .termos-condicoes h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.1em;
        color: #000;
        border-bottom: 1px dashed #999;
        padding-bottom: 5px;
    }

    .termos-condicoes ol {
        padding-left: 20px;
        margin-bottom: 10px;
    }

    .termos-condicoes li {
        margin-bottom: 5px;
    }
    .termos-condicoes p {
      margin: 0;
      font-size: 0.9em;
    }
    .termos-condicoes strong {
      color: #000;
    }

    .garantia-dias-span {
        display: inline-block;
        width: 60px;
        border-bottom: 1px solid #000;
        text-align: center;
        line-height: 1;
        vertical-align: middle;
    }

    .assinaturas-row {
        display: flex;
        justify-content: space-around;
        margin-top: 30px;
        text-align: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .assinatura-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 200px;
    }

    .linha-assinatura {
        border-bottom: 1px solid #000;
        width: 100%;
        margin-bottom: 5px;
        min-height: 1.5em; /* Garante que a linha apareça mesmo sem conteúdo */
    }

    .linha-assinatura-label {
        font-size: 0.9em;
        color: #333;
        font-weight: bold;
    }

    /* Ocultar elementos não essenciais na impressão */
    @media print {
        body {
            overflow: visible !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .barra-progresso, header, .conteudo, .main-actions {
            display: none !important;
        }
        .print-area {
            display: block !important;
            width: 100% !important;
            padding: 10mm !important; /* Margens de impressão */
            border: none !important;
            box-shadow: none !important;
            margin: 0 !important;
        }
        .print-only-field {
            border: 1px solid #000 !important;
            padding: 2px 4px !important;
            min-height: 1.2em !important;
        }
        .titulo img {
            filter: grayscale(100%) !important; /* Print em preto e branco */
        }
        .termos-condicoes {
            border: 1px solid #000 !important;
            background-color: #fff !important;
            box-shadow: none !important;
        }
        * {
            -webkit-print-color-adjust: exact !important; /* Garante cores no print */
            print-color-adjust: exact !important;
        }
    }
    /* Estilos para o popup de mensagem */
    .message-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: var(--input-bg);
      color: var(--text-light);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      text-align: center;
      font-size: 1.1em;
    }

    .message-popup button {
      background-color: var(--accent-color);
      color: var(--text-light);
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      font-size: 1em;
      transition: background-color 0.3s ease;
    }

    .message-popup button:hover {
      background-color: var(--accent-hover);
    }

  </style>
</head>
<body>
  <div class="barra-progresso">
    <div id="barra"></div>
  </div>

  <div class="container">
    <header>
      <h1>Nova Ordem de Serviço</h1>
      <div class="header-buttons">
        <button id="homeButton" onclick="goHome()">Início</button>
        <button id="historicoButton" onclick="goHistorico()">Histórico</button>
      </div>
    </header>

    <div class="conteudo">
      <form id="osForm" class="formulario-wrapper" onsubmit="event.preventDefault(); printOS();">
        <div class="form-section">
          <h2>Dados da Ordem de Serviço</h2>
          <div class="form-group">
            <label for="osNumber">Número da OS:</label>
            <input type="text" id="osNumber" required readonly>
          </div>
          <div class="form-group">
            <label for="dataEntrada">Data de Entrada:</label>
            <input type="date" id="dataEntrada" required readonly>
          </div>
          <div class="form-group">
            <label for="dataSaida">Data de Saída (Opcional):</label>
            <input type="date" id="dataSaida">
          </div>
          <div class="form-group">
            <label for="tecnico">Técnico Responsável:</label>
            <input type="text" id="tecnico" value="Seu Nome" required>
          </div>
        </div>

        <div class="form-section">
          <h2>Dados do Cliente</h2>
          <div class="form-group">
            <label for="nomeCliente">Nome do Cliente:</label>
            <input type="text" id="nomeCliente" required>
          </div>
          <div class="form-group">
            <label for="telefone">Telefone:</label>
            <input type="tel" id="telefone" placeholder="(DD) XXXXX-XXXX" maxlength="15" oninput="formatarTelefone(this)" required>
          </div>
        </div>

        <div class="form-section">
          <h2>Dados do Equipamento</h2>
          <div class="form-group">
            <label for="equipamento">Equipamento:</label>
            <input type="text" id="equipamento" required>
          </div>
          <div class="form-group">
            <label>Acessório:</label>
            <div class="radio-group">
              <label><input type="radio" name="acessorio" id="acessorioSim" value="sim" onchange="configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio')"> Sim</label>
              <label><input type="radio" name="acessorio" id="acessorioNao" value="nao" onchange="configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio')" checked> Não</label>
            </div>
            <div id="campoAcessorio" class="condicional-campo">
              <label for="qualAcessorio">Qual acessório?</label>
              <input type="text" id="qualAcessorio">
            </div>
          </div>

          <div class="form-group">
            <label>Liga o equipamento?</label>
            <div class="radio-group">
              <label><input type="radio" name="liga" id="ligaSim" value="sim"> Sim</label>
              <label><input type="radio" name="liga" id="ligaNao" value="nao" checked> Não</label>
            </div>
          </div>

          <div class="form-group">
            <label>Defeito Físico?</label>
            <div class="radio-group">
              <label><input type="radio" name="defeitoFisico" id="defeitoSim" value="sim" onchange="configurarRadios('defeitoFisico', 'campoDefeito', 'qualDefeito')"> Sim</label>
              <label><input type="radio" name="defeitoFisico" id="defeitoNao" value="nao" onchange="configurarRadios('defeitoFisico', 'campoDefeito', 'qualDefeito')" checked> Não</label>
            </div>
            <div id="campoDefeito" class="condicional-campo">
              <label for="qualDefeito">Qual defeito físico?</label>
              <input type="text" id="qualDefeito">
            </div>
          </div>

          <div class="form-group">
            <label for="defeitoRelatado">Defeito Relatado pelo Cliente:</label>
            <textarea id="defeitoRelatado" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="garantiaDias">Dias de Garantia:</label>
            <input type="number" id="garantiaDias" value="90" min="0" required>
          </div>
        </div>

        <div class="main-actions">
          <button type="submit" id="mainActionButton">Imprimir OS</button>
        </div>
      </form>
    </div>
  </div>

  <div id="printContainer" style="display: none;"></div>

  <div id="messagePopup" class="message-popup">
    <p id="popupMessage"></p>
    <button onclick="hideMessagePopup()">Ok</button>
  </div>

  <script>
    // Variáveis globais para controle de progresso
    let currentStep = 0;
    const totalSteps = 6; // Ajuste conforme o número de seções/campos importantes

    document.addEventListener('DOMContentLoaded', (event) => {
      loadLastOSNumber();
      setTodayDate();
      configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio');
      // Correção: Use 'defeitoFisico' para o radio group de defeito físico
      configurarRadios('defeitoFisico', 'campoDefeito', 'qualDefeito');
      atualizarProgresso(); // Atualiza a barra de progresso inicial
    });

    function showMessagePopup(message) {
        document.getElementById('popupMessage').innerText = message;
        document.getElementById('messagePopup').style.display = 'block';
    }

    function hideMessagePopup() {
        document.getElementById('messagePopup').style.display = 'none';
    }

    function goHome() {
      window.location.href = 'index.html'; // Assume que index.html é a tela inicial
    }

    function goHistorico() {
      window.location.href = 'historico.html'; // Navega para a página de histórico
    }

    function loadLastOSNumber() {
        let lastOSNumber = localStorage.getItem('last_os_number');
        if (lastOSNumber) {
            lastOSNumber = parseInt(lastOSNumber) + 1;
        } else {
            lastOSNumber = 1; // Começa com 1 se for a primeira OS
        }
        document.getElementById('osNumber').value = lastOSNumber.toString().padStart(4, '0');
    }

    function setTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('dataEntrada').value = `${yyyy}-${mm}-${dd}`;
    }

    function formatarTelefone(input) {
      let value = input.value.replace(/\D/g, ""); // Remove tudo que não é dígito
      let formattedValue = '';

      if (value.length > 0) {
        formattedValue = '(' + value.substring(0, 2);
      }
      if (value.length > 2) {
        formattedValue += ') ' + value.substring(2, 7);
      }
      if (value.length > 7) {
        formattedValue += '-' + value.substring(7, 11);
      }
      input.value = formattedValue;
    }

    function configurarRadios(name, campoId, inputId) {
      const radioSim = document.getElementById(`${name}Sim`);
      const campoCondicional = document.getElementById(campoId);
      const inputCondicional = document.getElementById(inputId);

      if (radioSim && campoCondicional && inputCondicional) {
        if (radioSim.checked) {
          campoCondicional.classList.add('show');
          inputCondicional.setAttribute('required', 'true');
        } else {
          campoCondicional.classList.remove('show');
          inputCondicional.removeAttribute('required');
          inputCondicional.value = ''; // Limpa o valor quando o campo é ocultado
        }
      }
    }

    // --- FUNÇÕES DE SALVAMENTO E IMPRESSÃO ---

    // Função para gerar um ID único para cada OS
    function generateUniqueId() {
        return '_' + Math.random().toString(36).substr(2, 9);
    }

    // Função para coletar os dados e salvar no localStorage
    function saveOS() {
        const osNumber = document.getElementById('osNumber').value;
        if (!osNumber) {
            console.error("Erro: Número da OS vazio ao tentar salvar.");
            showMessagePopup("Erro ao salvar: O número da OS está vazio.");
            return false; // Retorna false se o número da OS estiver vazio
        }

        const dataEntrada = document.getElementById('dataEntrada').value;
        if (!dataEntrada) {
            console.error("Erro: Data de Entrada vazia ao tentar salvar.");
            showMessagePopup("Erro ao salvar: A Data de Entrada está vazia.");
            return false;
        }

        const nomeCliente = document.getElementById('nomeCliente').value;
        if (!nomeCliente) {
            console.error("Erro: Nome do Cliente vazio ao tentar salvar.");
            showMessagePopup("Erro ao salvar: O Nome do Cliente está vazio.");
            return false;
        }

        const equipamento = document.getElementById('equipamento').value;
        if (!equipamento) {
            console.error("Erro: Equipamento vazio ao tentar salvar.");
            showMessagePopup("Erro ao salvar: O Equipamento está vazio.");
            return false;
        }

        const defeitoRelatado = document.getElementById('defeitoRelatado').value;
        if (!defeitoRelatado) {
            console.error("Erro: Defeito Relatado vazio ao tentar salvar.");
            showMessagePopup("Erro ao salvar: O Defeito Relatado está vazio.");
            return false;
        }

        // Coleta todos os dados relevantes do formulário
        const osData = {
            id: generateUniqueId(), // ID único para fácil localização depois
            timestamp: Date.now(), // Para ordenação no histórico (mais recente primeiro)
            osNumber: osNumber,
            dataEntrada: formatDateToDisplay(document.getElementById('dataEntrada').value), // Formata para exibição
            dataSaida: formatDateToDisplay(document.getElementById('dataSaida').value) || '___/___/___',
            nomeCliente: nomeCliente,
            telefone: document.getElementById('telefone').value,
            tecnico: document.getElementById('tecnico').value,
            equipamento: equipamento,
            acessorioSim: document.getElementById('acessorioSim').checked,
            qualAcessorio: document.getElementById('qualAcessorio').value,
            ligaSim: document.getElementById('ligaSim').checked,
            defeitoFisicoSim: document.getElementById('defeitoSim').checked,
            qualDefeito: document.getElementById('qualDefeito').value,
            defeitoRelatado: defeitoRelatado,
            garantiaDias: document.getElementById('garantiaDias').value || '90'
        };

        // Pega o histórico atual ou um array vazio se não houver nada
        const osHistory = JSON.parse(localStorage.getItem('os_history') || '[]');

        // Adiciona a nova OS ao histórico
        osHistory.push(osData);

        // Salva o histórico atualizado de volta no localStorage
        localStorage.setItem('os_history', JSON.stringify(osHistory));

        // Atualiza o último número de OS salvo
        localStorage.setItem('last_os_number', parseInt(osNumber));

        console.log('OS salva no histórico:', osData);
        return true; // Retorna true se a OS foi salva com sucesso
    }

    // Função auxiliar para formatar datas para exibição (DD/MM/AAAA)
    function formatDateToDisplay(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    // Função para gerar o conteúdo HTML para impressão
    function createPrintableContent(isClientCopy) {
        const osNumber = document.getElementById('osNumber').value;
        const dataEntrada = formatDateToDisplay(document.getElementById('dataEntrada').value);
        const dataSaida = formatDateToDisplay(document.getElementById('dataSaida').value) || '___/___/___';
        const nomeCliente = document.getElementById('nomeCliente').value;
        const telefone = document.getElementById('telefone').value;
        const tecnico = document.getElementById('tecnico').value;
        const equipamento = document.getElementById('equipamento').value;
        const acessorioSim = document.getElementById('acessorioSim').checked;
        const qualAcessorio = document.getElementById('qualAcessorio').value;
        const ligaSim = document.getElementById('ligaSim').checked;
        const defeitoFisicoSim = document.getElementById('defeitoSim').checked;
        const qualDefeito = document.getElementById('qualDefeito').value;
        const defeitoRelatado = document.getElementById('defeitoRelatado').value;
        const garantiaDias = document.getElementById('garantiaDias').value || '90';


        const termosCondicoesHTML = `
            <div class="termos-condicoes">
              <h3>Termos e Condições</h3>
              <ol>
                <li>
                  <strong>Recebimento do Equipamento</strong>
                  <p>O equipamento entregue será avaliado, registrando estado físico, avarias e acessórios recebidos. Não nos responsabilizamos por itens não declarados.</p>
                </li>
                <li>
                  <strong>Diagnóstico e Orçamento</strong>
                  <p>O diagnóstico será realizado em até 3 dias úteis. O serviço só será iniciado após aprovação do orçamento pelo cliente.</p>
                </li>
                <li>
                  <strong>Garantia</strong>
                  <p>Garantia de <span class="garantia-dias-span">${garantiaDias}</span> dias para o serviço realizado, limitada ao reparo efetuado. Não cobre mau uso, quedas, líquidos ou intervenções de terceiros.</p>
                </li>
                <li>
                  <strong>Equipamentos Não Retirados</strong>
                  <p>Após 30 dias da conclusão, será cobrada taxa de armazenamento de R$ 1,00/dia. Após 90 dias, o equipamento será considerado abandonado, conforme o Código Civil Artigo 1.275, inciso III.</p>
                </li>
                <li>
                  <strong>Perda de Dados</strong>
                  <p>Não nos responsabilizamos por perda de dados. Recomenda-se backup antes da entrega. Backup solicitado será cobrado à parte.</p>
                </li>
                <li>
                  <strong>Peças Substituídas</strong>
                  <p>Garantia de <span class="garantia-dias-span">${garantiaDias}</span> dias para peças substituídas contra defeitos de fabricação. Peças originais mediante solicitação e disponibilidade.</p>
                </li>
              </ol>
            </div>
        `;

        return `
            <div class="print-area">
                <div class="titulo">
                  <img src="logo.png" alt="Logo CNT Assistência Técnica">
                  <div class="contato">Contato: 84 99809-6865</div>
                </div>
                <h2>${isClientCopy ? 'VIA DO CLIENTE' : 'ORDEM DE SERVIÇO'}</h2>
                <div class="linha">
                    <div class="col"><label>OS Nº</label><span class="print-only-field">${osNumber}</span></div>
                    <div class="col"><label>DATA ENTRADA</label><span class="print-only-field">${dataEntrada}</span></div>
                    <div class="col"><label>DATA SAÍDA</label><span class="print-only-field">${dataSaida}</span></div>
                </div>
                <div class="linha">
                    <div class="col"><label>CLIENTE</label><span class="print-only-field">${nomeCliente}</span></div>
                    <div class="col"><label>TELEFONE</label><span class="print-only-field">${telefone}</span></div>
                    <div class="col"><label>TÉCNICO</label><span class="print-only-field">${tecnico}</span></div>
                </div>
                <div class="linha">
                    <div class="col"><label>EQUIPAMENTO</label><span class="print-only-field">${equipamento}</span></div>
                </div>
                <div class="linha">
                    <div class="col"><label>ACESSÓRIO</label><span class="print-only-field">${acessorioSim ? 'SIM' : 'NÃO'}</span></div>
                    ${acessorioSim && qualAcessorio ? `<div class="col"><label>QUAL</label><span class="print-only-field">${qualAcessorio}</span></div>` : ''}
                </div>
                <div class="linha">
                    <div class="col"><label>LIGA</label><span class="print-only-field">${ligaSim ? 'SIM' : 'NÃO'}</span></div>
                </div>
                <div class="linha">
                    <div class="col"><label>DEFEITO FÍSICO</label><span class="print-only-field">${defeitoFisicoSim ? 'SIM' : 'NÃO'}</span></div>
                    ${defeitoFisicoSim && qualDefeito ? `<div class="col"><label>QUAL</label><span class="print-only-field">${qualDefeito}</span></div>` : ''}
                </div>
                <div class="linha">
                    <div class="col"><label>DEFEITO RELATADO</label><span class="print-only-field" style="min-height: 3.5em;">${defeitoRelatado}</span></div>
                </div>
                ${termosCondicoesHTML}
                <div class="linha assinaturas-row">
                    <div class="col">
                        <div class="assinatura-container">
                            <span class="linha-assinatura"></span>
                            <span class="linha-assinatura-label">ASS. CLIENTE / ENTREGA</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="assinatura-container">
                            <span class="linha-assinatura"></span>
                            <span class="linha-assinatura-label">ASS. CNT ASSISTÊNCIA / RETIRADA</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function printOS() {
        // Valida o formulário antes de prosseguir com a impressão e salvamento
        if (!document.getElementById('osForm').checkValidity()) {
            // Se a validação falhar, o navegador já mostra os erros.
            // Opcional: Você pode adicionar um alerta mais amigável aqui se quiser.
            showMessagePopup("Por favor, preencha todos os campos obrigatórios antes de imprimir.");
            return;
        }

        // Tenta salvar a OS. Se saveOS retornar false (por erro de validação interna ou campos vazios),
        // a impressão não deve continuar.
        const osSavedSuccessfully = saveOS();
        if (!osSavedSuccessfully) {
            return; // Interrompe a função se o salvamento falhou
        }

        const printContainer = document.getElementById('printContainer');
        printContainer.innerHTML = ''; // Limpa o conteúdo existente

        // Gera a via da loja
        const lojaCopy = createPrintableContent(false);
        printContainer.appendChild(lojaCopy);

        // Gera a via do cliente
        const clientCopy = createPrintableContent(true);
        printContainer.appendChild(clientCopy);

        // Esconde o formulário da tela e mostra a área de impressão
        document.querySelector('.conteudo').style.display = 'none';
        document.getElementById('mainActionButton').style.display = 'none';
        // Oculta os botões de cabeçalho durante a impressão
        document.getElementById('homeButton').style.display = 'none';
        document.getElementById('historicoButton').style.display = 'none';


        printContainer.style.display = 'block';

        setTimeout(() => {
            window.print();
            // Após a impressão, reverte para o estado original
            document.querySelector('.conteudo').style.display = 'block';
            document.getElementById('mainActionButton').style.display = 'block';
            // Mostra os botões de cabeçalho novamente
            document.getElementById('homeButton').style.display = 'block';
            document.getElementById('historicoButton').style.display = 'block';

            printContainer.style.display = 'none';
            printContainer.innerHTML = ''; // Limpa a área de impressão novamente

            // Garante que os campos condicionais da tela voltem ao estado correto
            configurarRadios('acessorio', 'campoAcessorio', 'qualAcessorio');
            // Correção: Use 'defeitoFisico' para o radio group de defeito físico
            configurarRadios('defeitoFisico', 'campoDefeito', 'qualDefeito');
            
            // Opcional: Reiniciar a OS para um novo preenchimento após salvar e imprimir
            // Isso pode ser útil para o fluxo de trabalho
            setTimeout(() => {
                location.reload(); // Recarrega a página para uma nova OS limpa e incrementa o número da OS
            }, 100); // Pequeno delay para garantir que a impressão seja processada
        }, 300);
    }

    function atualizarProgresso() {
      // Esta função precisa ser chamada em cada input change ou focus para ser efetiva.
      // Ou você pode associá-la a eventos de navegação entre "passos" se tiver.
      // Por enquanto, ela apenas define o progresso inicial.
      const form = document.getElementById('osForm');
      const inputs = form.querySelectorAll('input[required], textarea[required]');
      let filledCount = 0;

      inputs.forEach(input => {
        if (input.value.trim() !== '') {
          filledCount++;
        }
      });

      const progress = Math.round((filledCount / inputs.length) * 100);
      const barraElement = document.getElementById("barra");
      if (barraElement) {
        barraElement.style.height = progress + "%";
      }
    }
    // Adicionar listeners para atualizar progresso em tempo real
    document.querySelectorAll('#osForm input, #osForm textarea, #osForm select').forEach(input => {
        input.addEventListener('input', atualizarProgresso);
        input.addEventListener('change', atualizarProgresso); // Para radios/checkboxes
    });

  </script>
</body>
</html>
